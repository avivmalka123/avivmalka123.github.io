<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Script Generator âœ¦</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap');

:root {
  --bg:#080810; --surface:#10101c; --surface2:#16162a; --surface3:#1e1e38;
  --border:rgba(255,255,255,0.08); --text:#e8e8f0; --muted:#6b6b8a;
  --accent:#7c3aed; --pink:#ec4899; --green:#10b981; --red:#ef4444;
  --cyan:#06b6d4; --amber:#f59e0b; --glow:rgba(124,58,237,0.35);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Heebo',sans-serif;min-height:100vh;direction:rtl;}
body::before{content:'';position:fixed;top:-30%;right:-10%;width:600px;height:600px;
  background:radial-gradient(circle,rgba(124,58,237,0.1) 0%,transparent 65%);
  pointer-events:none;animation:drift 20s ease-in-out infinite alternate;z-index:0;}
@keyframes drift{0%{transform:translate(0,0)}100%{transform:translate(40px,60px)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(124,58,237,0.4)}50%{box-shadow:0 0 0 8px rgba(124,58,237,0)}}

/* Nav */
nav{position:fixed;top:0;left:0;right:0;z-index:100;height:58px;
  background:rgba(8,8,16,0.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;padding:0 32px;}
.logo{display:flex;align-items:center;gap:10px;font-size:16px;font-weight:800;text-decoration:none;color:var(--text);}
.logo-dot{width:32px;height:32px;background:linear-gradient(135deg,var(--accent),var(--pink));
  border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:15px;box-shadow:0 0 16px var(--glow);}
.logo span{background:linear-gradient(135deg,#a855f7,#ec4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.back{font-size:13px;color:var(--muted);text-decoration:none;padding:6px 14px;
  border-radius:8px;border:1px solid var(--border);transition:all 0.2s;}
.back:hover{color:var(--text);background:var(--surface2);}

/* Page */
.page{position:relative;z-index:1;max-width:680px;margin:0 auto;padding:94px 24px 80px;}

/* Header */
.ph{text-align:center;margin-bottom:40px;}
.ph h1{font-size:clamp(26px,5vw,42px);font-weight:900;letter-spacing:-1px;line-height:1.1;margin-bottom:10px;}
.gr{font-style:normal;background:linear-gradient(135deg,#a855f7,#ec4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.ph p{font-size:14px;color:var(--muted);line-height:1.6;}

/* Settings */
.sw{background:var(--surface);border:1px solid var(--border);border-radius:16px;margin-bottom:16px;overflow:hidden;}
.st{width:100%;display:flex;align-items:center;justify-content:space-between;padding:13px 20px;
  background:none;border:none;color:var(--muted);font-family:'Heebo',sans-serif;
  font-size:13px;font-weight:600;cursor:pointer;text-align:right;transition:color 0.2s;}
.st:hover{color:var(--text);}
.st .ar{transition:transform 0.25s;font-size:11px;}
.st.open .ar{transform:rotate(180deg);}
.sb{display:none;padding:4px 20px 20px;}
.sb.open{display:block;}
.fg{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;}
.f{display:flex;flex-direction:column;gap:5px;}
.f.full{grid-column:1/-1;}
.f label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;}
.f input{background:var(--surface2);border:1px solid var(--border);border-radius:9px;
  padding:9px 12px;color:var(--text);font-family:'Heebo',sans-serif;font-size:13px;
  outline:none;transition:border-color 0.2s;width:100%;}
.f input[type=password]{direction:ltr;text-align:right;}
.f input:focus{border-color:var(--accent);}
.f input::placeholder{color:var(--muted);}
.fn{font-size:11px;color:var(--muted);margin-top:3px;}
.fn a{color:var(--cyan);text-decoration:none;}
.fn a:hover{text-decoration:underline;}
.chips{display:flex;gap:8px;margin-top:10px;}
.chip{display:flex;align-items:center;gap:5px;padding:4px 12px;border-radius:100px;font-size:11px;font-weight:700;}
.chip.ok{background:rgba(16,185,129,0.12);border:1px solid rgba(16,185,129,0.25);color:#34d399;}
.chip.no{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);color:#f87171;}

/* Drop Zone */
.dropzone{background:var(--surface);border:2px dashed rgba(168,85,247,0.3);border-radius:20px;
  padding:48px 24px;text-align:center;margin-bottom:16px;cursor:pointer;
  transition:all 0.25s;position:relative;}
.dropzone:hover,.dropzone.drag{border-color:rgba(168,85,247,0.7);background:rgba(124,58,237,0.05);}
.dropzone.has-file{border-style:solid;border-color:rgba(168,85,247,0.5);background:rgba(124,58,237,0.04);}
.dz-icon{font-size:42px;margin-bottom:14px;display:block;}
.dz-title{font-size:17px;font-weight:800;margin-bottom:6px;}
.dz-sub{font-size:13px;color:var(--muted);}
.dz-formats{font-size:11px;color:var(--muted);margin-top:8px;}
.dz-file{display:none;align-items:center;gap:12px;background:var(--surface2);
  border:1px solid var(--border);border-radius:12px;padding:14px 18px;margin-top:16px;text-align:right;}
.dz-file.show{display:flex;}
.dz-file-icon{font-size:24px;flex-shrink:0;}
.dz-file-name{font-size:14px;font-weight:700;flex:1;}
.dz-file-size{font-size:12px;color:var(--muted);}
.dz-remove{background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;
  padding:4px;line-height:1;flex-shrink:0;transition:color 0.2s;}
.dz-remove:hover{color:var(--red);}
#fileInput{display:none;}

/* Upload bar */
.upload-bar{height:4px;background:var(--surface2);border-radius:2px;overflow:hidden;margin-top:12px;display:none;}
.upload-bar.show{display:block;}
.upload-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--pink));
  border-radius:2px;transition:width 0.3s;width:0%;}

/* Go button */
.go-btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--accent),var(--pink));
  border:none;border-radius:12px;color:white;font-family:'Heebo',sans-serif;
  font-size:15px;font-weight:700;cursor:pointer;
  box-shadow:0 4px 24px rgba(124,58,237,0.4);transition:all 0.2s;
  display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:16px;}
.go-btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 32px rgba(124,58,237,0.55);}
.go-btn:disabled{opacity:0.4;cursor:not-allowed;transform:none;}
.spin{animation:spin 0.8s linear infinite;display:inline-block;}

/* Progress */
.prog{background:var(--surface);border:1px solid var(--border);border-radius:16px;
  padding:22px 24px;margin-bottom:16px;display:none;}
.prog.show{display:block;}
.steps{display:flex;flex-direction:column;gap:14px;}
.step{display:flex;align-items:flex-start;gap:12px;font-size:14px;color:var(--muted);transition:color 0.3s;}
.step.active{color:var(--text);}
.step.done{color:var(--green);}
.step.err{color:var(--red);}
.si{width:28px;height:28px;border-radius:50%;background:var(--surface2);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;
  flex-shrink:0;transition:all 0.3s;margin-top:1px;}
.step.active .si{background:var(--accent);border-color:var(--accent);color:white;animation:pulse 1.2s infinite;}
.step.done .si{background:var(--green);border-color:var(--green);color:white;}
.step.err .si{background:var(--red);border-color:var(--red);color:white;}
.step-info{flex:1;}
.step-label{font-weight:600;}
.step-detail{font-size:11px;color:var(--muted);margin-top:3px;}
.timer{display:flex;align-items:center;gap:8px;margin-top:14px;padding:9px 14px;
  background:rgba(6,182,212,0.06);border:1px solid rgba(6,182,212,0.15);border-radius:9px;
  font-size:12px;color:var(--cyan);display:none;}
.timer.show{display:flex;}
.tdot{width:6px;height:6px;border-radius:50%;background:var(--cyan);animation:pulse 1.2s infinite;}

/* Error */
.errb{background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.25);
  border-radius:12px;padding:14px 16px;font-size:13px;color:#fca5a5;line-height:1.6;
  margin-bottom:14px;display:none;}
.errb.show{display:block;}

/* Output */
.outbox{background:var(--surface);border:1px solid rgba(16,185,129,0.3);border-radius:16px;
  overflow:hidden;margin-bottom:16px;display:none;box-shadow:0 0 40px rgba(16,185,129,0.06);}
.outbox.show{display:block;}
.outh{padding:16px 20px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;gap:12px;}
.out-title{font-size:14px;font-weight:800;}
.out-meta{font-size:11px;color:var(--muted);}
.out-actions{display:flex;gap:8px;flex-shrink:0;}
.ab{padding:7px 14px;border-radius:8px;border:none;font-family:'Heebo',sans-serif;
  font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all 0.2s;}
.ab-copy{background:var(--surface2);border:1px solid var(--border);color:var(--text);}
.ab-copy:hover{background:var(--surface3);}
.ab-pdf{background:linear-gradient(135deg,#10b981,#059669);color:white;}
.ab-pdf:hover{transform:translateY(-1px);}
.outscript{padding:24px;font-size:14px;line-height:1.85;white-space:pre-wrap;
  direction:rtl;max-height:620px;overflow-y:auto;}
.outscript::-webkit-scrollbar{width:4px;}
.outscript::-webkit-scrollbar-track{background:transparent;}
.outscript::-webkit-scrollbar-thumb{background:var(--surface2);border-radius:2px;}
.slabel{display:block;font-size:11px;font-weight:800;color:var(--accent);
  text-transform:uppercase;letter-spacing:1px;margin:20px 0 6px;padding:4px 10px;
  background:rgba(124,58,237,0.1);border-right:3px solid var(--accent);border-radius:0 6px 6px 0;}

/* Toast */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:10px 20px;font-size:13px;font-weight:600;z-index:9999;
  transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
  box-shadow:0 8px 32px rgba(0,0,0,0.5);white-space:nowrap;}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast.ok{border-color:rgba(16,185,129,0.4);color:#34d399;}
.toast.er{border-color:rgba(239,68,68,0.4);color:#f87171;}

#pdfArea{position:fixed;top:-9999px;right:-9999px;width:820px;background:white;
  color:#111;font-family:Arial,sans-serif;direction:rtl;text-align:right;padding:52px;}
</style>
</head>
<body>

<nav>
  <a class="logo" href="/"><div class="logo-dot">âœ¦</div><span>Aviv Malka</span></a>
  <a class="back" href="/">â† ×›×œ ×”×›×œ×™×</a>
</nav>

<div class="page">

  <div class="ph">
    <h1>ğŸ™ï¸ <em class="gr">Script Generator</em></h1>
    <p>××¢×œ×” ×§×•×‘×¥ ××•×“×™×• â†’ ××ª××œ×œ ×¢× AssemblyAI â†’ ×›×•×ª×‘ ×¡×§×¨×™×¤×˜ ×‘×¢×‘×¨×™×ª ×’×‘×•×”×” ×¢× Claude</p>
  </div>

  <!-- Settings -->
  <div class="sw">
    <button class="st" id="stBtn" onclick="toggleSettings()">
      <span>âš™ï¸ &nbsp;×”×’×“×¨×•×ª â€” API Keys + ×¤×¨×•×¤×™×œ</span>
      <span class="ar">â–¼</span>
    </button>
    <div class="sb" id="stBody">
      <div class="fg">
        <div class="f">
          <label>AssemblyAI Key * â€” ×œ×ª××œ×•×œ</label>
          <input type="password" id="aaiKey" placeholder="××¤×ª×— AssemblyAI..." oninput="save()">
          <span class="fn">×”×¨×©××” ×—×™× ××™×ª â† <a href="https://www.assemblyai.com/" target="_blank">assemblyai.com</a> ($50 ×§×¨×“×™×˜)</span>
        </div>
        <div class="f">
          <label>Claude Key * â€” ×œ×¡×§×¨×™×¤×˜</label>
          <input type="password" id="clKey" placeholder="sk-ant-api03-..." oninput="save()">
          <span class="fn">â† <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a></span>
        </div>
        <div class="f">
          <label>×”×©× / ×”××•×ª×’ ×©×œ×š</label>
          <input type="text" id="uName" placeholder="Aviv Malka" oninput="save()">
        </div>
        <div class="f">
          <label>×ª×—×•× ×”××™×§×•××¨×¡</label>
          <input type="text" id="uNiche" placeholder="×“×¨×•×¤×©×™×¤×™× ×’, ×××–×•×Ÿ FBA..." oninput="save()">
        </div>
        <div class="f full">
          <label>×§×”×œ ×™×¢×“ / ×¡×’× ×•×Ÿ</label>
          <input type="text" id="uAud" placeholder="×™×–××™× 20-35, TikTok + Shopify, ×™×©×™×¨ ×•×××™×ª×™..." oninput="save()">
        </div>
      </div>
      <div class="chips">
        <div class="chip" id="chipA">â— AssemblyAI</div>
        <div class="chip" id="chipC">â— Claude</div>
      </div>
    </div>
  </div>

  <!-- Drop Zone -->
  <div class="dropzone" id="dropzone"
    onclick="document.getElementById('fileInput').click()"
    ondragover="onDragOver(event)"
    ondragleave="onDragLeave(event)"
    ondrop="onDrop(event)">
    <span class="dz-icon" id="dzIcon">ğŸµ</span>
    <div class="dz-title" id="dzTitle">×’×¨×•×¨ ×§×•×‘×¥ ××•×“×™×• ×œ×›××Ÿ</div>
    <div class="dz-sub" id="dzSub">××• ×œ×—×¥ ×œ×‘×—×™×¨×ª ×§×•×‘×¥</div>
    <div class="dz-formats">MP3 Â· MP4 Â· WAV Â· M4A Â· AAC Â· OGG Â· WEBM</div>
    <div class="dz-file" id="dzFile">
      <span class="dz-file-icon">ğŸµ</span>
      <div>
        <div class="dz-file-name" id="dzFileName"></div>
        <div class="dz-file-size" id="dzFileSize"></div>
      </div>
      <button class="dz-remove" onclick="removeFile(event)">âœ•</button>
    </div>
    <div class="upload-bar" id="uploadBar"><div class="upload-fill" id="uploadFill"></div></div>
  </div>
  <input type="file" id="fileInput" accept="audio/*,video/mp4,video/webm" onchange="onFileSelect(event)">

  <!-- Go -->
  <button class="go-btn" id="goBtn" onclick="startProcess()">
    <span id="goBtnIcon">âœ¨</span>
    <span id="goBtnText">×ª××œ×œ ×•×¦×•×¨ ×¡×§×¨×™×¤×˜</span>
  </button>

  <!-- Progress -->
  <div class="prog" id="prog">
    <div class="steps">
      <div class="step" id="s0">
        <div class="si" id="s0i">1</div>
        <div class="step-info">
          <div class="step-label">×”×¢×œ××ª ×”×§×•×‘×¥ ×œ-AssemblyAI</div>
          <div class="step-detail" id="s0d"></div>
        </div>
      </div>
      <div class="step" id="s1">
        <div class="si" id="s1i">2</div>
        <div class="step-info">
          <div class="step-label">×ª××œ×•×œ â€” ×××–×™×Ÿ ×œ××•×“×™×•</div>
          <div class="step-detail" id="s1d">×××ª×™×Ÿ...</div>
        </div>
      </div>
      <div class="step" id="s2">
        <div class="si" id="s2i">3</div>
        <div class="step-info">
          <div class="step-label">×›×ª×™×‘×ª ×¡×§×¨×™×¤×˜ ×¢× Claude</div>
          <div class="step-detail" id="s2d"></div>
        </div>
      </div>
    </div>
    <div class="timer" id="timer">
      <div class="tdot"></div>
      <span>××ª××œ×œ... <span id="timerN">0</span> ×©× ×™×•×ª</span>
    </div>
  </div>

  <!-- Error -->
  <div class="errb" id="errb"></div>

  <!-- Output -->
  <div class="outbox" id="outbox">
    <div class="outh">
      <div>
        <div class="out-title" id="outTitle">×”×¡×§×¨×™×¤×˜ ××•×›×Ÿ âœ“</div>
        <div class="out-meta"  id="outMeta"></div>
      </div>
      <div class="out-actions">
        <button class="ab ab-copy" onclick="copyScript()">ğŸ“‹ ×”×¢×ª×§</button>
        <button class="ab ab-pdf"  onclick="dlPDF()">ğŸ“„ PDF</button>
      </div>
    </div>
    <div class="outscript" id="outScript"></div>
  </div>

</div>

<div class="toast" id="toast"></div>
<div id="pdfArea"></div>

<script>
// â”€â”€ State â”€â”€
let S = { aaiKey:'', clKey:'', uName:'', uNiche:'', uAud:'' };
let selectedFile = null;
let transcript = '', script = '', wc = 0;
let timerIv = null, timerN = 0;

// â”€â”€ Init â”€â”€
loadSettings();

// â”€â”€ Settings â”€â”€
function save() {
  S.aaiKey = g('aaiKey'); S.clKey  = g('clKey');
  S.uName  = g('uName');  S.uNiche = g('uNiche'); S.uAud = g('uAud');
  localStorage.setItem('sg4', JSON.stringify(S));
  refreshChips();
}
function loadSettings() {
  try {
    const d = JSON.parse(localStorage.getItem('sg4')||'{}');
    Object.assign(S, d);
    ['aaiKey','clKey','uName','uNiche','uAud'].forEach(id => {
      if(d[id]) document.getElementById(id).value = d[id];
    });
  } catch(e) {}
  refreshChips();
}
function refreshChips() {
  setChip('chipA', !!S.aaiKey);
  setChip('chipC', !!S.clKey);
}
function setChip(id, ok) {
  const el = document.getElementById(id);
  el.className = 'chip ' + (ok ? 'ok' : 'no');
  el.querySelector ? null : null;
  el.innerHTML = (ok ? 'âœ“ ' : 'âœ— ') + el.innerHTML.replace(/^[âœ“âœ—] /,'');
}
function toggleSettings() {
  const b = document.getElementById('stBody'), btn = document.getElementById('stBtn');
  btn.classList.toggle('open', b.classList.toggle('open'));
}
function openSettings() {
  document.getElementById('stBody').classList.add('open');
  document.getElementById('stBtn').classList.add('open');
}

// â”€â”€ File handling â”€â”€
function onFileSelect(e) {
  const f = e.target.files[0];
  if (f) setFile(f);
}
function onDragOver(e) {
  e.preventDefault();
  document.getElementById('dropzone').classList.add('drag');
}
function onDragLeave(e) {
  document.getElementById('dropzone').classList.remove('drag');
}
function onDrop(e) {
  e.preventDefault();
  document.getElementById('dropzone').classList.remove('drag');
  const f = e.dataTransfer.files[0];
  if (f) setFile(f);
}
function setFile(f) {
  selectedFile = f;
  document.getElementById('dzFileName').textContent = f.name;
  document.getElementById('dzFileSize').textContent = formatSize(f.size);
  document.getElementById('dzFile').classList.add('show');
  document.getElementById('dzIcon').textContent = 'âœ…';
  document.getElementById('dzTitle').textContent = '×§×•×‘×¥ × ×‘×—×¨';
  document.getElementById('dzSub').textContent   = '×œ×—×¥ "×ª××œ×œ ×•×¦×•×¨ ×¡×§×¨×™×¤×˜" ×›×“×™ ×œ×”×ª×—×™×œ';
  document.getElementById('dropzone').classList.add('has-file');
}
function removeFile(e) {
  e.stopPropagation();
  selectedFile = null;
  document.getElementById('dzFile').classList.remove('show');
  document.getElementById('dzIcon').textContent  = 'ğŸµ';
  document.getElementById('dzTitle').textContent = '×’×¨×•×¨ ×§×•×‘×¥ ××•×“×™×• ×œ×›××Ÿ';
  document.getElementById('dzSub').textContent   = '××• ×œ×—×¥ ×œ×‘×—×™×¨×ª ×§×•×‘×¥';
  document.getElementById('dropzone').classList.remove('has-file');
  document.getElementById('fileInput').value = '';
  document.getElementById('uploadBar').classList.remove('show');
}
function formatSize(b) {
  if (b > 1048576) return (b/1048576).toFixed(1) + ' MB';
  return (b/1024).toFixed(0) + ' KB';
}

// â”€â”€ Steps UI â”€â”€
function setStep(i, state, detail) {
  const el = document.getElementById('s'+i);
  const ic = document.getElementById('s'+i+'i');
  const dt = document.getElementById('s'+i+'d');
  el.className = 'step ' + state;
  ic.textContent = state==='done' ? 'âœ“' : state==='err' ? 'âœ—' : i+1;
  if (dt && detail !== undefined) dt.textContent = detail;
}
function resetSteps() {
  [0,1,2].forEach(i => setStep(i,'',''));
  stopTimer();
}

// â”€â”€ Timer â”€â”€
function startTimer() {
  timerN = 0;
  document.getElementById('timer').classList.add('show');
  timerIv = setInterval(() => {
    timerN++;
    document.getElementById('timerN').textContent = timerN;
    setStep(1, 'active', `××ª××œ×œ... (${timerN} ×©× ×™×•×ª)`);
  }, 1000);
}
function stopTimer() {
  clearInterval(timerIv);
  document.getElementById('timer').classList.remove('show');
}

// â”€â”€ Upload to AssemblyAI â”€â”€
async function uploadFile(file, apiKey) {
  // Show upload bar
  const bar  = document.getElementById('uploadBar');
  const fill = document.getElementById('uploadFill');
  bar.classList.add('show');

  // Read file as ArrayBuffer
  const buf = await file.arrayBuffer();

  // Simulate progress while uploading (real XHR progress is complex with fetch)
  let prog = 0;
  const progIv = setInterval(() => {
    prog = Math.min(prog + 8, 90);
    fill.style.width = prog + '%';
  }, 200);

  const res = await fetch('https://api.assemblyai.com/v2/upload', {
    method: 'POST',
    headers: {
      'Authorization': apiKey,
      'Content-Type': file.type || 'audio/mpeg',
    },
    body: buf
  });

  clearInterval(progIv);
  fill.style.width = '100%';
  setTimeout(() => bar.classList.remove('show'), 600);

  if (!res.ok) {
    const e = await res.json().catch(()=>({}));
    throw new Error(e?.error || `Upload failed (${res.status})`);
  }
  const { upload_url } = await res.json();
  return upload_url;
}

// â”€â”€ Transcribe with AssemblyAI â”€â”€
async function transcribeUrl(uploadUrl, apiKey) {
  const sub = await fetch('https://api.assemblyai.com/v2/transcript', {
    method: 'POST',
    headers: { 'Authorization': apiKey, 'Content-Type': 'application/json' },
    body: JSON.stringify({
      audio_url: uploadUrl,
      language_detection: true,
      punctuate: true,
      format_text: true
    })
  });
  if (!sub.ok) {
    const e = await sub.json().catch(()=>({}));
    throw new Error(e?.error || `Transcription submit failed (${sub.status})`);
  }
  const { id } = await sub.json();

  startTimer();
  let attempts = 0;
  while (true) {
    await sleep(4000);
    attempts++;
    const poll = await fetch(`https://api.assemblyai.com/v2/transcript/${id}`, {
      headers: { 'Authorization': apiKey }
    });
    const d = await poll.json();
    if (d.status === 'completed') { stopTimer(); return d.text || ''; }
    if (d.status === 'error')     { stopTimer(); throw new Error(d.error || '×©×’×™××ª ×ª××œ×•×œ'); }
    if (attempts > 150)           { stopTimer(); throw new Error('×”×ª××œ×•×œ ×œ×•×§×— ×™×•×ª×¨ ××“×™ ×–××Ÿ â€” × ×¡×” ×©×•×‘'); }
  }
}

// â”€â”€ Generate Script with Claude â”€â”€
async function generateScript(text, wc) {
  if (!S.clKey) throw new Error('× ×“×¨×© Claude API Key');
  const name  = S.uName  || '×”×™×•×¦×¨';
  const niche = S.uNiche || '××™×§×•××¨×¡';
  const aud   = S.uAud   || '';

  const prompt = `××ª×” ××•××—×” ×œ×›×ª×™×‘×ª ×¡×§×¨×™×¤×˜×™× ×œ×¡×¨×˜×•× ×™ ×™×•×˜×™×•×‘ â€” ×¢×‘×¨×™×ª ×’×‘×•×”×”, ×××™×ª×™×ª, ×“×™×‘×•×¨×™×ª.

**×ª××œ×•×œ ×”×¡×¨×˜×•×Ÿ:**
"""
${text.slice(0, 7500)}${text.length > 7500 ? '\n[...]' : ''}
"""

**×¤×¨×˜×™ ×”×™×•×¦×¨:**
×©×: ${name} | ×ª×—×•×: ${niche}${aud ? ` | ×§×”×œ: ${aud}` : ''}

**×”× ×—×™×•×ª:**
- ×›×ª×•×‘ ×¡×§×¨×™×¤×˜ ×—×“×© ×œ×—×œ×•×˜×™×Ÿ â€” ×œ× ×ª×¨×’×•×, ×œ× ×¤×¨×¤×¨×–×”
- ××•×ª×• × ×•×©× ×•××‘× ×”, ×× ×§×•×“×ª ×”××‘×˜ ×©×œ ${name} ×‘×¢×•×œ× ×”${niche}
- ××•×¨×š ×–×”×”: ~${wc} ××™×œ×™×
- ×¢×‘×¨×™×ª ×“×™×‘×•×¨×™×ª ×’×‘×•×”×”, ×›××™×œ×• ${name} ××“×‘×¨ ××•×œ ××¦×œ××”
- ××‘× ×”: ×”×•×§ â†’ ×¤×ª×™×—×” â†’ ×’×•×£ â†’ ×¡×™×›×•× + CTA

**×¤×•×¨××˜:**

[HOOK]
(30 ×©× ×™×•×ª ×¨××©×•× ×•×ª â€” ××©×¤×˜ ×©×’×•×¨× ×œ×”××©×™×š ×œ×¦×¤×•×ª)

[INTRO]
(×”×¦×’×” ×§×¦×¨×” + ×”×‘×˜×—×” ××” ×”×¦×•×¤×” ×™×§×‘×œ)

[BODY]
(×’×•×£ ×”×¡×¨×˜×•×Ÿ, ×¤×¡×§××•×ª ×××•×¡×¤×¨×•×ª)

[OUTRO]
(×¡×™×›×•× + ×§×¨×™××” ×œ×¤×¢×•×œ×” â€” ×× ×•×™, ×ª×’×•×‘×”, ×œ×™× ×§)

[TITLE]
×›×•×ª×¨×ª ××•×¦×¢×ª ×œ×¡×¨×˜×•×Ÿ

×›×ª×•×‘ ××ª ×”×¡×§×¨×™×¤×˜ ×‘×œ×‘×“.`;

  const res = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': S.clKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({ model:'claude-opus-4-6', max_tokens:8192, messages:[{role:'user',content:prompt}] })
  });
  if (!res.ok) {
    let m = `Claude Error ${res.status}`;
    try { m = (await res.json())?.error?.message || m; } catch(e) {}
    throw new Error(m);
  }
  return (await res.json()).content[0].text;
}

// â”€â”€ Main â”€â”€
async function startProcess() {
  if (!selectedFile) { showToast('×‘×—×¨ ×§×•×‘×¥ ××•×“×™×• ×ª×—×™×œ×”', 'er'); return; }
  if (!S.aaiKey || !S.clKey) {
    showToast('× ×“×¨×©×™× ×©× ×™ ×”-API Keys ×‘×”×’×“×¨×•×ª', 'er');
    openSettings(); return;
  }

  hide('errb'); hide('outbox');
  show('prog');
  setBtn(true, '<span class="spin">â³</span>', '×¢×•×‘×“...');
  resetSteps();
  transcript = ''; script = ''; wc = 0;

  // Step 1 â€” Upload
  setStep(0, 'active', '');
  let uploadUrl;
  try {
    uploadUrl = await uploadFile(selectedFile, S.aaiKey);
    setStep(0, 'done', formatSize(selectedFile.size) + ' ×”×•×¢×œ×” ×‘×”×¦×œ×—×”');
  } catch(e) {
    setStep(0, 'err');
    showErr(`×©×’×™××ª ×”×¢×œ××”: ${e.message}`);
    setBtn(false); return;
  }

  // Step 2 â€” Transcribe
  setStep(1, 'active', '×©×•×œ×— ×œ-AssemblyAI...');
  try {
    transcript = await transcribeUrl(uploadUrl, S.aaiKey);
    wc = transcript.split(/\s+/).filter(w=>w).length;
    setStep(1, 'done', `${wc.toLocaleString()} ××™×œ×™× ×‘×ª××œ×•×œ`);
  } catch(e) {
    setStep(1, 'err');
    showErr(`×©×’×™××ª ×ª××œ×•×œ: ${e.message}`);
    setBtn(false); return;
  }

  // Step 3 â€” Script
  setStep(2, 'active', '');
  try {
    script = await generateScript(transcript, wc);
    setStep(2, 'done', '');
    showOutput();
    showToast('âœ“ ×”×¡×§×¨×™×¤×˜ ××•×›×Ÿ!', 'ok');
  } catch(e) {
    setStep(2, 'err');
    showErr(`×©×’×™××ª Claude: ${e.message}`);
  }
  setBtn(false);
}

// â”€â”€ Output â”€â”€
function showOutput() {
  document.getElementById('outTitle').textContent = '×”×¡×§×¨×™×¤×˜ ××•×›×Ÿ âœ“';
  document.getElementById('outMeta').textContent  = `~${wc.toLocaleString()} ××™×œ×™× ×‘×ª××œ×•×œ`;
  document.getElementById('outScript').innerHTML  = fmtScript(script);
  show('outbox');
  document.getElementById('outbox').scrollIntoView({behavior:'smooth',block:'start'});
}
function fmtScript(s) {
  return s
    .replace(/\[HOOK\]/g,  '<span class="slabel">ğŸ£ ×”×•×§ â€” 30 ×©× ×™×•×ª ×¨××©×•× ×•×ª</span>')
    .replace(/\[INTRO\]/g, '<span class="slabel">ğŸ‘‹ ×¤×ª×™×—×”</span>')
    .replace(/\[BODY\]/g,  '<span class="slabel">ğŸ“ ×’×•×£ ×”×¡×¨×˜×•×Ÿ</span>')
    .replace(/\[OUTRO\]/g, '<span class="slabel">ğŸš€ ×¡×™×›×•× ×•×§×¨×™××” ×œ×¤×¢×•×œ×”</span>')
    .replace(/\[TITLE\]/g, '<span class="slabel">ğŸ“Œ ×›×•×ª×¨×ª ××•×¦×¢×ª</span>')
    .replace(/\n/g,'<br>');
}
function copyScript() {
  if (!script) return;
  navigator.clipboard.writeText(script)
    .then(()=>showToast('âœ“ ×”×•×¢×ª×§','ok')).catch(()=>showToast('×œ× × ×™×ª×Ÿ','er'));
}
async function dlPDF() {
  if (!script) return;
  showToast('â³ ×™×•×¦×¨ PDF...','ok');
  try {
    const clean = script
      .replace(/\[HOOK\]/g,  '\nâ”â”â” ğŸ£ ×”×•×§ â”â”â”\n')
      .replace(/\[INTRO\]/g, '\nâ”â”â” ğŸ‘‹ ×¤×ª×™×—×” â”â”â”\n')
      .replace(/\[BODY\]/g,  '\nâ”â”â” ğŸ“ ×’×•×£ ×”×¡×¨×˜×•×Ÿ â”â”â”\n')
      .replace(/\[OUTRO\]/g, '\nâ”â”â” ğŸš€ ×¡×™×›×•× ×•CTA â”â”â”\n')
      .replace(/\[TITLE\]/g, '\nâ”â”â” ğŸ“Œ ×›×•×ª×¨×ª ××•×¦×¢×ª â”â”â”\n');
    document.getElementById('pdfArea').innerHTML = `
      <div style="border-bottom:3px solid #7c3aed;padding-bottom:20px;margin-bottom:28px;">
        <div style="font-size:11px;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">
          SCRIPT GENERATOR Â· ${new Date().toLocaleDateString('he-IL')}</div>
        <h1 style="font-size:22px;font-weight:900;color:#111;line-height:1.2;">
          ${esc(selectedFile?.name || '×”×¡×§×¨×™×¤×˜ ×©×œ×™')}</h1>
        <div style="font-size:12px;color:#666;margin-top:6px;">
          ${esc(S.uName||'')} Â· ~${wc.toLocaleString()} ××™×œ×™×</div>
      </div>
      <div style="font-size:13px;line-height:1.85;white-space:pre-wrap;color:#111;">${esc(clean)}</div>`;
    const {jsPDF} = window.jspdf;
    const canvas = await html2canvas(document.getElementById('pdfArea'),{scale:1.5,backgroundColor:'#fff',logging:false});
    const doc=new jsPDF('p','mm','a4');
    const m=12,pw=210-m*2,pxpm=canvas.width/pw,phPx=(297-m*2)*pxpm;
    const pages=Math.ceil(canvas.height/phPx);
    for(let p=0;p<pages;p++){
      if(p>0) doc.addPage();
      const sy=p*phPx,sh=Math.min(phPx,canvas.height-sy);
      const tmp=document.createElement('canvas');
      tmp.width=canvas.width;tmp.height=sh;
      tmp.getContext('2d').drawImage(canvas,0,sy,canvas.width,sh,0,0,canvas.width,sh);
      doc.addImage(tmp.toDataURL('image/jpeg',0.92),'JPEG',m,m,pw,sh/pxpm);
    }
    const fname=(selectedFile?.name||'script').replace(/\.[^.]+$/,'').replace(/[^\w\u0590-\u05FF\s-]/g,'').trim().replace(/\s+/g,'-').slice(0,60);
    doc.save(`${fname}.pdf`);
    showToast(`âœ“ "${fname}.pdf" ×”×•×¨×“`,'ok');
  } catch(e) {
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([script],{type:'text/plain;charset=utf-8'}));
    a.download='script.txt';a.click();
    showToast('×”×•×¨×“ ×›×˜×§×¡×˜','ok');
  }
}

// â”€â”€ Helpers â”€â”€
function g(id)   { return document.getElementById(id).value.trim(); }
function show(id){ document.getElementById(id).classList.add('show'); }
function hide(id){ document.getElementById(id).classList.remove('show'); }
function showErr(m){ const e=document.getElementById('errb');e.textContent=m;e.classList.add('show'); }
function setBtn(d,icon='âœ¨',txt='×ª××œ×œ ×•×¦×•×¨ ×¡×§×¨×™×¤×˜'){
  document.getElementById('goBtn').disabled=d;
  document.getElementById('goBtnIcon').innerHTML=icon;
  document.getElementById('goBtnText').textContent=txt;
}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
let toastT;
function showToast(m,c='ok'){
  const e=document.getElementById('toast');
  e.textContent=m;e.className=`toast ${c} show`;
  clearTimeout(toastT);toastT=setTimeout(()=>e.classList.remove('show'),3800);
}
</script>
</body>
</html>
