<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Script Generator âœ¦</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap');

:root {
  --bg:#080810; --surface:#10101c; --surface2:#16162a; --surface3:#1e1e38;
  --border:rgba(255,255,255,0.08); --text:#e8e8f0; --muted:#6b6b8a;
  --accent:#7c3aed; --pink:#ec4899; --green:#10b981; --red:#ef4444;
  --cyan:#06b6d4; --glow:rgba(124,58,237,0.35);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Heebo',sans-serif;min-height:100vh;direction:rtl;}
body::before{content:'';position:fixed;top:-30%;right:-10%;width:600px;height:600px;
  background:radial-gradient(circle,rgba(124,58,237,0.1) 0%,transparent 65%);
  pointer-events:none;animation:drift 20s ease-in-out infinite alternate;z-index:0;}
@keyframes drift{0%{transform:translate(0,0)}100%{transform:translate(40px,60px)}}
@keyframes spin{to{transform:rotate(360deg)}}

/* Nav */
nav{position:fixed;top:0;left:0;right:0;z-index:100;height:58px;
  background:rgba(8,8,16,0.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;padding:0 32px;}
.logo{display:flex;align-items:center;gap:10px;font-size:16px;font-weight:800;text-decoration:none;color:var(--text);}
.logo-dot{width:32px;height:32px;background:linear-gradient(135deg,var(--accent),var(--pink));
  border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:15px;box-shadow:0 0 16px var(--glow);}
.logo span{background:linear-gradient(135deg,#a855f7,#ec4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.back{font-size:13px;color:var(--muted);text-decoration:none;padding:6px 14px;
  border-radius:8px;border:1px solid var(--border);transition:all 0.2s;}
.back:hover{color:var(--text);background:var(--surface2);}

/* Page */
.page{position:relative;z-index:1;max-width:760px;margin:0 auto;padding:94px 24px 80px;}

/* Header */
.ph{text-align:center;margin-bottom:36px;}
.ph h1{font-size:clamp(26px,5vw,40px);font-weight:900;letter-spacing:-1px;line-height:1.1;margin-bottom:10px;}
.gr{font-style:normal;background:linear-gradient(135deg,#a855f7,#ec4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.ph p{font-size:14px;color:var(--muted);line-height:1.6;}

/* Settings panel */
.sw{background:var(--surface);border:1px solid var(--border);border-radius:16px;margin-bottom:20px;overflow:hidden;}
.st{width:100%;display:flex;align-items:center;justify-content:space-between;padding:13px 20px;
  background:none;border:none;color:var(--muted);font-family:'Heebo',sans-serif;
  font-size:13px;font-weight:600;cursor:pointer;text-align:right;transition:color 0.2s;}
.st:hover{color:var(--text);}
.st .ar{transition:transform 0.25s;font-size:11px;}
.st.open .ar{transform:rotate(180deg);}
.sb{display:none;padding:4px 20px 20px;}
.sb.open{display:block;}
.fg{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;}
.f{display:flex;flex-direction:column;gap:5px;}
.f.full{grid-column:1/-1;}
.f label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;}
.f input{background:var(--surface2);border:1px solid var(--border);border-radius:9px;
  padding:9px 12px;color:var(--text);font-family:'Heebo',sans-serif;font-size:13px;
  outline:none;transition:border-color 0.2s;width:100%;}
.f input[type=password]{direction:ltr;text-align:right;}
.f input:focus{border-color:var(--accent);}
.f input::placeholder{color:var(--muted);}
.fn{font-size:11px;color:var(--muted);margin-top:2px;}
.fn a{color:var(--cyan);text-decoration:none;}
.fn a:hover{text-decoration:underline;}
.chip{display:inline-flex;align-items:center;gap:5px;padding:4px 12px;border-radius:100px;font-size:11px;font-weight:700;margin-top:8px;}
.chip.ok{background:rgba(16,185,129,0.12);border:1px solid rgba(16,185,129,0.25);color:#34d399;}
.chip.no{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);color:#f87171;}

/* Input blocks */
.block{background:var(--surface);border:1px solid var(--border);border-radius:16px;
  padding:20px;margin-bottom:16px;transition:border-color 0.2s,box-shadow 0.2s;}
.block:focus-within{border-color:rgba(168,85,247,0.4);box-shadow:0 0 0 4px rgba(124,58,237,0.07);}
.block-header{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:12px;}
.block-title{font-size:13px;font-weight:800;display:flex;align-items:center;gap:8px;}
.block-badge{font-size:10px;background:var(--surface2);border:1px solid var(--border);
  border-radius:6px;padding:2px 8px;color:var(--muted);}
.wc-badge{font-size:11px;color:var(--muted);}

textarea{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;
  padding:14px;color:var(--text);font-family:'Heebo',sans-serif;font-size:13px;line-height:1.65;
  outline:none;resize:vertical;direction:rtl;transition:border-color 0.2s;}
textarea:focus{border-color:rgba(168,85,247,0.5);}
textarea::placeholder{color:var(--muted);}
#transcriptTA{min-height:200px;}
#instructTA{min-height:110px;}

/* Go button */
.go-btn{width:100%;padding:15px;background:linear-gradient(135deg,var(--accent),var(--pink));
  border:none;border-radius:13px;color:white;font-family:'Heebo',sans-serif;
  font-size:15px;font-weight:700;cursor:pointer;
  box-shadow:0 4px 24px rgba(124,58,237,0.4);transition:all 0.2s;
  display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:20px;}
.go-btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 32px rgba(124,58,237,0.55);}
.go-btn:disabled{opacity:0.4;cursor:not-allowed;transform:none;}
.spin{animation:spin 0.8s linear infinite;display:inline-block;}

/* Progress */
.prog-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;
  padding:22px 24px;margin-bottom:16px;display:none;}
.prog-box.show{display:block;}

/* Percentage display */
.pct-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.pct-label{font-size:13px;font-weight:700;color:var(--text);}
.pct-num{font-size:22px;font-weight:900;background:linear-gradient(135deg,#a855f7,#ec4899);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.pct-bar-wrap{width:100%;height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;margin-bottom:18px;}
.pct-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--pink));
  border-radius:3px;transition:width 0.5s ease;width:0%;}

/* Steps */
.steps{display:flex;flex-direction:column;gap:10px;}
.step{display:flex;align-items:center;gap:10px;font-size:13px;color:var(--muted);transition:color 0.3s;}
.step.active{color:var(--text);}
.step.done{color:var(--green);}
.step.err{color:var(--red);}
.si{width:22px;height:22px;border-radius:50%;background:var(--surface2);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;
  flex-shrink:0;transition:all 0.3s;}
.step.active .si{background:var(--accent);border-color:var(--accent);color:white;
  animation:pulse-dot 1.2s infinite;}
.step.done .si{background:var(--green);border-color:var(--green);color:white;}
.step.err  .si{background:var(--red);border-color:var(--red);color:white;}
@keyframes pulse-dot{0%,100%{box-shadow:0 0 0 0 rgba(124,58,237,0.4)}50%{box-shadow:0 0 0 7px rgba(124,58,237,0)}}

/* Error */
.errb{background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.25);
  border-radius:12px;padding:14px 16px;font-size:13px;color:#fca5a5;line-height:1.6;
  margin-bottom:14px;display:none;}
.errb.show{display:block;}

/* Output */
.outbox{background:var(--surface);border:1px solid rgba(16,185,129,0.3);border-radius:16px;
  overflow:hidden;margin-bottom:16px;display:none;box-shadow:0 0 40px rgba(16,185,129,0.06);}
.outbox.show{display:block;}
.outh{padding:16px 20px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;gap:12px;}
.out-title{font-size:14px;font-weight:800;}
.out-meta{font-size:11px;color:var(--muted);margin-top:2px;}
.out-acts{display:flex;gap:8px;flex-shrink:0;}
.ab{padding:7px 14px;border-radius:8px;border:none;font-family:'Heebo',sans-serif;
  font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all 0.2s;}
.ab-copy{background:var(--surface2);border:1px solid var(--border);color:var(--text);}
.ab-copy:hover{background:var(--surface3);}
.ab-pdf{background:linear-gradient(135deg,#10b981,#059669);color:white;}
.ab-pdf:hover{transform:translateY(-1px);}
.ab-new{background:var(--surface2);border:1px solid var(--border);color:var(--muted);}
.ab-new:hover{color:var(--text);}
.outscript{padding:24px;font-size:14px;line-height:1.9;white-space:pre-wrap;
  direction:rtl;max-height:680px;overflow-y:auto;}
.outscript::-webkit-scrollbar{width:4px;}
.outscript::-webkit-scrollbar-track{background:transparent;}
.outscript::-webkit-scrollbar-thumb{background:var(--surface2);border-radius:2px;}
.slabel{display:block;font-size:11px;font-weight:800;color:var(--accent);
  text-transform:uppercase;letter-spacing:1px;margin:22px 0 6px;padding:5px 12px;
  background:rgba(124,58,237,0.1);border-right:3px solid var(--accent);border-radius:0 6px 6px 0;}

/* Toast */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:10px 20px;font-size:13px;font-weight:600;z-index:9999;
  transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
  box-shadow:0 8px 32px rgba(0,0,0,0.5);white-space:nowrap;}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast.ok{border-color:rgba(16,185,129,0.4);color:#34d399;}
.toast.er{border-color:rgba(239,68,68,0.4);color:#f87171;}

#pdfArea{position:fixed;top:-9999px;right:-9999px;width:820px;background:white;
  color:#111;font-family:Arial,sans-serif;direction:rtl;text-align:right;padding:52px;}
</style>
</head>
<body>

<nav>
  <a class="logo" href="/"><div class="logo-dot">âœ¦</div><span>Aviv Malka</span></a>
  <a class="back" href="/">â† ×›×œ ×”×›×œ×™×</a>
</nav>

<div class="page">

  <!-- Header -->
  <div class="ph">
    <h1>âœï¸ <em class="gr">Script Generator</em></h1>
    <p>××“×‘×™×§ ×ª××œ×•×œ + ××•×¡×™×£ ×”×•×¨××•×ª â†’ Claude ×›×•×ª×‘ ×¡×§×¨×™×¤×˜ ××•×ª×× ××™×©×™×ª ×‘×¢×‘×¨×™×ª ×’×‘×•×”×”</p>
  </div>

  <!-- Settings -->
  <div class="sw">
    <button class="st" id="stBtn" onclick="toggleSettings()">
      <span>âš™ï¸ &nbsp;×”×’×“×¨×•×ª â€” Claude API Key + ×¤×¨×•×¤×™×œ</span>
      <span class="ar">â–¼</span>
    </button>
    <div class="sb" id="stBody">
      <div class="fg">
        <div class="f">
          <label>Claude API Key *</label>
          <input type="password" id="clKey" placeholder="sk-ant-api03-..." oninput="save()">
          <span class="fn">â† <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a></span>
        </div>
        <div class="f">
          <label>×”×©× / ×”××•×ª×’ ×©×œ×š</label>
          <input type="text" id="uName" placeholder="Aviv Malka" oninput="save()">
        </div>
        <div class="f">
          <label>×ª×—×•× ×”××™×§×•××¨×¡</label>
          <input type="text" id="uNiche" placeholder="×“×¨×•×¤×©×™×¤×™× ×’, ×××–×•×Ÿ FBA..." oninput="save()">
        </div>
        <div class="f">
          <label>×§×”×œ ×™×¢×“ / ×¡×’× ×•×Ÿ</label>
          <input type="text" id="uAud" placeholder="×™×–××™× 20-35, TikTok + Shopify..." oninput="save()">
        </div>
      </div>
      <div id="chipWrap"></div>
    </div>
  </div>

  <!-- Transcript -->
  <div class="block">
    <div class="block-header">
      <div class="block-title">
        ğŸ“„ ×ª××œ×•×œ ××§×•×¨×™
        <span class="block-badge">×”×“×‘×§ ×›××Ÿ</span>
      </div>
      <span class="wc-badge" id="wcBadge"></span>
    </div>
    <textarea id="transcriptTA"
      placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×”×ª××œ×•×œ ×”××œ× ×©×œ ×”×¡×¨×˜×•×Ÿ...&#10;&#10;× ×™×ª×Ÿ ×œ×”×“×‘×™×§ ×ª××œ×•×œ ××™×•×˜×™×•×‘, ×-Whisper, ××›×œ ××§×•×¨ ××—×¨ â€” ×›×œ ×”×˜×§×¡×˜ ×©×¨×•×¦×™×."
      oninput="updateWC()"></textarea>
  </div>

  <!-- Instructions -->
  <div class="block">
    <div class="block-header">
      <div class="block-title">
        ğŸ¯ ×”× ×—×™×•×ª ×œ×¡×§×¨×™×¤×˜
        <span class="block-badge">××™×š ×œ×§×©×¨ ×œ××™×§×•××¨×¡ ×©×œ×š</span>
      </div>
    </div>
    <textarea id="instructTA"
      placeholder="×¡×¤×¨ ×œ×™ ××™×š ×œ×§×—×ª ××ª ×”×ª××œ×•×œ ×”×–×” ×•×œ×—×‘×¨ ××•×ª×• ×œ×¢×•×œ× ×©×œ×š. ×œ×“×•×’××”:&#10;&#10;â€¢ ×× ×™ ×¨×•×¦×” ×œ×§×©×¨ ××ª ×”× ×•×©× ×œ×“×¨×•×¤×©×™×¤×™× ×’ ×¢× Shopify&#10;â€¢ ×ª×“×’×™×© ××ª ×—×©×™×‘×•×ª ×”×“××˜×” ×‘×‘×—×™×¨×ª ××•×¦×¨&#10;â€¢ ×”×•×¡×£ × ×§×•×“×” ×¢×œ ×¤×¨×¡×•× ×‘-TikTok&#10;â€¢ ×”×¡×§×¨×™×¤×˜ ××™×•×¢×“ ×œ×§×”×œ ×©×œ ××ª×—×™×œ×™×&#10;â€¢ ×©××•×¨ ×¢×œ ×˜×•×Ÿ ××™×©×™ ×•×××™×ª×™, ×œ× ×©×™×•×•×§×™ ××“×™"></textarea>
  </div>

  <!-- Generate -->
  <button class="go-btn" id="goBtn" onclick="generate()">
    <span id="goBtnIcon">âœ¨</span>
    <span id="goBtnText">×¦×•×¨ ×¡×§×¨×™×¤×˜</span>
  </button>

  <!-- Progress -->
  <div class="prog-box" id="progBox">
    <div class="pct-row">
      <span class="pct-label" id="pctLabel">××¢×‘×“...</span>
      <span class="pct-num" id="pctNum">0%</span>
    </div>
    <div class="pct-bar-wrap">
      <div class="pct-bar" id="pctBar"></div>
    </div>
    <div class="steps">
      <div class="step" id="s0"><div class="si" id="s0i">1</div><span>×× ×ª×— ××ª ×”×ª××œ×•×œ</span></div>
      <div class="step" id="s1"><div class="si" id="s1i">2</div><span>××—×‘×¨ ×œ× ×•×©××™× ×©×‘×™×§×©×ª</span></div>
      <div class="step" id="s2"><div class="si" id="s2i">3</div><span>×›×•×ª×‘ ×¡×§×¨×™×¤×˜ ×‘×¢×‘×¨×™×ª ×’×‘×•×”×”</span></div>
      <div class="step" id="s3"><div class="si" id="s3i">4</div><span>××¢×¦×‘ ×•××¡×™×™×</span></div>
    </div>
  </div>

  <!-- Error -->
  <div class="errb" id="errb"></div>

  <!-- Output -->
  <div class="outbox" id="outbox">
    <div class="outh">
      <div>
        <div class="out-title">×”×¡×§×¨×™×¤×˜ ××•×›×Ÿ âœ“</div>
        <div class="out-meta" id="outMeta"></div>
      </div>
      <div class="out-acts">
        <button class="ab ab-copy" onclick="copyScript()">ğŸ“‹ ×”×¢×ª×§</button>
        <button class="ab ab-pdf"  onclick="dlPDF()">ğŸ“„ PDF</button>
        <button class="ab ab-new"  onclick="resetOutput()">â†º ×—×“×©</button>
      </div>
    </div>
    <div class="outscript" id="outScript"></div>
  </div>

</div>

<div class="toast" id="toast"></div>
<div id="pdfArea"></div>

<script>
// â”€â”€ State â”€â”€
let S = { clKey:'', uName:'', uNiche:'', uAud:'' };
let script = '', wc = 0;
let pctTarget = 0, pctCurrent = 0, pctIv = null;

// â”€â”€ Init â”€â”€
loadSettings();

// â”€â”€ Settings â”€â”€
function save() {
  S.clKey  = g('clKey');
  S.uName  = g('uName');
  S.uNiche = g('uNiche');
  S.uAud   = g('uAud');
  localStorage.setItem('sg5', JSON.stringify(S));
  renderChip();
}
function loadSettings() {
  try {
    const d = JSON.parse(localStorage.getItem('sg5')||'{}');
    Object.assign(S, d);
    ['clKey','uName','uNiche','uAud'].forEach(id => {
      if (d[id]) document.getElementById(id).value = d[id];
    });
  } catch(e) {}
  renderChip();
}
function renderChip() {
  const wrap = document.getElementById('chipWrap');
  if (S.clKey) {
    wrap.innerHTML = '<div class="chip ok">âœ“ Claude API Key ××•×’×“×¨</div>';
  } else {
    wrap.innerHTML = '<div class="chip no">âœ— Claude API Key ×—×¡×¨</div>';
  }
}
function toggleSettings() {
  const b = document.getElementById('stBody'), btn = document.getElementById('stBtn');
  btn.classList.toggle('open', b.classList.toggle('open'));
}
function openSettings() {
  document.getElementById('stBody').classList.add('open');
  document.getElementById('stBtn').classList.add('open');
}

// â”€â”€ Word count â”€â”€
function updateWC() {
  const text = document.getElementById('transcriptTA').value;
  const count = text.trim() ? text.trim().split(/\s+/).length : 0;
  document.getElementById('wcBadge').textContent = count > 0 ? `${count.toLocaleString()} ××™×œ×™×` : '';
}

// â”€â”€ Progress â”€â”€
function setPct(target, label) {
  pctTarget = target;
  if (label) document.getElementById('pctLabel').textContent = label;
  clearInterval(pctIv);
  pctIv = setInterval(() => {
    if (pctCurrent < pctTarget) {
      pctCurrent = Math.min(pctCurrent + 1, pctTarget);
      document.getElementById('pctNum').textContent = pctCurrent + '%';
      document.getElementById('pctBar').style.width = pctCurrent + '%';
    } else {
      clearInterval(pctIv);
    }
  }, 18);
}
function setStep(i, state) {
  const el = document.getElementById('s'+i);
  const ic = document.getElementById('s'+i+'i');
  el.className = 'step ' + state;
  ic.textContent = state==='done' ? 'âœ“' : state==='err' ? 'âœ—' : i+1;
}
function resetProg() {
  pctCurrent = 0; pctTarget = 0;
  clearInterval(pctIv);
  document.getElementById('pctNum').textContent = '0%';
  document.getElementById('pctBar').style.width = '0%';
  document.getElementById('pctLabel').textContent = '××¢×‘×“...';
  [0,1,2,3].forEach(i => setStep(i,''));
}

// â”€â”€ Generate â”€â”€
async function generate() {
  const transcript = document.getElementById('transcriptTA').value.trim();
  const instruct   = document.getElementById('instructTA').value.trim();

  if (!transcript) { showToast('×”×“×‘×§ ×ª××œ×•×œ ×ª×—×™×œ×”', 'er'); return; }
  if (!S.clKey) {
    showToast('× ×“×¨×© Claude API Key', 'er');
    openSettings(); return;
  }

  hide('errb'); hide('outbox');
  show('progBox');
  setBtn(true, '<span class="spin">â³</span>', '×›×•×ª×‘...');
  resetProg();
  script = '';

  const transcriptWC = transcript.split(/\s+/).filter(w=>w).length;

  // Animate steps with percentages
  setPct(15, '×× ×ª×— ×ª××œ×•×œ...');
  setStep(0, 'active');
  await sleep(600);
  setStep(0, 'done');

  setPct(30, '××—×‘×¨ ×œ× ×•×©××™× ×©×‘×™×§×©×ª...');
  setStep(1, 'active');
  await sleep(500);
  setStep(1, 'done');

  setPct(50, '×©×•×œ×— ×œ-Claude...');
  setStep(2, 'active');

  const name  = S.uName  || '×”×™×•×¦×¨';
  const niche = S.uNiche || '××™×§×•××¨×¡';
  const aud   = S.uAud   || '';

  const prompt = `××ª×” ××•××—×” ×œ×›×ª×™×‘×ª ×¡×§×¨×™×¤×˜×™× ×œ×¡×¨×˜×•× ×™ ×™×•×˜×™×•×‘ â€” ×¢×‘×¨×™×ª ×’×‘×•×”×”, ×××™×ª×™×ª, ×“×™×‘×•×¨×™×ª.

**×ª××œ×•×œ ×”××§×•×¨:**
"""
${transcript.slice(0, 8000)}${transcript.length > 8000 ? '\n[...]' : ''}
"""

**×”× ×—×™×•×ª ×”×™×•×¦×¨:**
${instruct || '×§×©×¨ ××ª ×”× ×•×©× ×œ×¢×•×œ× ×”××™×§×•××¨×¡ ×©×œ ×”×™×•×¦×¨'}

**×¤×¨×˜×™ ×”×™×•×¦×¨:**
×©×: ${name} | ×ª×—×•×: ${niche}${aud ? ` | ×§×”×œ: ${aud}` : ''}

**××” ×œ×›×ª×•×‘:**
- ×§×¨× ×•× ×ª×— ××ª ×”×ª××œ×•×œ â€” ×”×‘×Ÿ ××ª ×”× ×•×©×, ×”×¨×¢×™×•× ×•×ª ×”××¨×›×–×™×™×, ×•×”××‘× ×”
- ×›×ª×•×‘ ×¡×§×¨×™×¤×˜ ×—×“×© ×œ×—×œ×•×˜×™×Ÿ ×‘×¢×‘×¨×™×ª â€” ×œ× ×ª×¨×’×•×, ×œ× ×¤×¨×¤×¨×–×”
- ×©×œ×‘ ××ª ×”×”× ×—×™×•×ª ×©×œ ×”×™×•×¦×¨ ×•××ª ×”× ×§×•×“×•×ª ×©×”×•× ×¨×•×¦×” ×œ×”×“×’×™×©
- ×—×‘×¨ ×”×›×œ ×œ×¢×•×œ× ×”${niche} ×•×œ×¤×¨×•×¤×™×œ ×©×œ ${name}
- ××•×¨×š: ~${transcriptWC} ××™×œ×™× (×–×”×” ×œ×ª××œ×•×œ ×”××§×•×¨×™)
- ×¢×‘×¨×™×ª ×“×™×‘×•×¨×™×ª ×’×‘×•×”×” â€” ×›××™×œ×• ${name} ××“×‘×¨ ×™×©×™×¨×•×ª ××•×œ ××¦×œ××”

**×¤×•×¨××˜ ×—×•×‘×”:**

[HOOK]
(30 ×©× ×™×•×ª ×¨××©×•× ×•×ª â€” ××©×¤×˜ ×¤×ª×™×—×” ×©×’×•×¨× ×œ×¦×¤×•×ª)

[INTRO]
(×”×¦×’×” + ×”×‘×˜×—×” ××” ×”×¦×•×¤×” ×™×§×‘×œ)

[BODY]
(×’×•×£ ×”×¡×¨×˜×•×Ÿ â€” ×¤×¡×§××•×ª ×××•×¡×¤×¨×•×ª, ×›×œ × ×§×•×“×” ××¤×•×ª×—×ª)

[OUTRO]
(×¡×™×›×•× + ×§×¨×™××” ×œ×¤×¢×•×œ×”)

[TITLE]
×›×•×ª×¨×ª ××•×¦×¢×ª ×œ×¡×¨×˜×•×Ÿ

×›×ª×•×‘ ××ª ×”×¡×§×¨×™×¤×˜ ×‘×œ×‘×“.`;

  try {
    // Stream the response
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': S.clKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-opus-4-6',
        max_tokens: 8192,
        stream: true,
        messages: [{ role:'user', content: prompt }]
      })
    });

    if (!res.ok) {
      let m = `Claude Error ${res.status}`;
      try { m = (await res.json())?.error?.message || m; } catch(e) {}
      throw new Error(m);
    }

    // Read stream
    setPct(55, 'Claude ×›×•×ª×‘...');
    setStep(2, 'active');

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    let fullText = '';
    let tokens = 0;

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop();
      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const data = line.slice(6);
        if (data === '[DONE]') continue;
        try {
          const j = JSON.parse(data);
          if (j.type === 'content_block_delta' && j.delta?.text) {
            fullText += j.delta.text;
            tokens++;
            // Update progress as tokens arrive (50% â†’ 95%)
            const progress = Math.min(55 + Math.floor(tokens / 4), 95);
            if (progress > pctCurrent) setPct(progress, 'Claude ×›×•×ª×‘...');
          }
        } catch(e) {}
      }
    }

    script = fullText;
    wc = transcriptWC;

    setStep(2, 'done');
    setStep(3, 'active');
    setPct(98, '××¡×™×™×...');
    await sleep(400);
    setStep(3, 'done');
    setPct(100, 'âœ“ ×”×¡×§×¨×™×¤×˜ ××•×›×Ÿ!');

    await sleep(300);
    showOutput(transcriptWC);
    showToast('âœ“ ×”×¡×§×¨×™×¤×˜ ××•×›×Ÿ!', 'ok');

  } catch(e) {
    setStep(2, 'err');
    setPct(pctCurrent, '×©×’×™××”');
    showErr(`×©×’×™××”: ${e.message}`);
  }

  setBtn(false);
}

// â”€â”€ Output â”€â”€
function showOutput(origWC) {
  const scriptWC = script.split(/\s+/).filter(w=>w).length;
  document.getElementById('outMeta').textContent =
    `${scriptWC.toLocaleString()} ××™×œ×™× ×‘×¡×§×¨×™×¤×˜ Â· ××§×•×¨: ${origWC.toLocaleString()} ××™×œ×™× ×‘×ª××œ×•×œ`;
  document.getElementById('outScript').innerHTML = fmtScript(script);
  show('outbox');
  document.getElementById('outbox').scrollIntoView({ behavior:'smooth', block:'start' });
}

function fmtScript(s) {
  return s
    .replace(/\[HOOK\]/g,  '<span class="slabel">ğŸ£ ×”×•×§ â€” 30 ×©× ×™×•×ª ×¨××©×•× ×•×ª</span>')
    .replace(/\[INTRO\]/g, '<span class="slabel">ğŸ‘‹ ×¤×ª×™×—×”</span>')
    .replace(/\[BODY\]/g,  '<span class="slabel">ğŸ“ ×’×•×£ ×”×¡×¨×˜×•×Ÿ</span>')
    .replace(/\[OUTRO\]/g, '<span class="slabel">ğŸš€ ×¡×™×›×•× ×•×§×¨×™××” ×œ×¤×¢×•×œ×”</span>')
    .replace(/\[TITLE\]/g, '<span class="slabel">ğŸ“Œ ×›×•×ª×¨×ª ××•×¦×¢×ª</span>')
    .replace(/\n/g, '<br>');
}

function resetOutput() {
  hide('outbox'); hide('progBox'); hide('errb');
  resetProg();
  script = '';
}

function copyScript() {
  if (!script) return;
  navigator.clipboard.writeText(script)
    .then(() => showToast('âœ“ ×”×•×¢×ª×§', 'ok'))
    .catch(() => showToast('×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§', 'er'));
}

async function dlPDF() {
  if (!script) return;
  showToast('â³ ×™×•×¦×¨ PDF...', 'ok');
  try {
    const clean = script
      .replace(/\[HOOK\]/g,  '\nâ”â”â” ğŸ£ ×”×•×§ â”â”â”\n')
      .replace(/\[INTRO\]/g, '\nâ”â”â” ğŸ‘‹ ×¤×ª×™×—×” â”â”â”\n')
      .replace(/\[BODY\]/g,  '\nâ”â”â” ğŸ“ ×’×•×£ ×”×¡×¨×˜×•×Ÿ â”â”â”\n')
      .replace(/\[OUTRO\]/g, '\nâ”â”â” ğŸš€ ×¡×™×›×•× ×•CTA â”â”â”\n')
      .replace(/\[TITLE\]/g, '\nâ”â”â” ğŸ“Œ ×›×•×ª×¨×ª ××•×¦×¢×ª â”â”â”\n');

    document.getElementById('pdfArea').innerHTML = `
      <div style="border-bottom:3px solid #7c3aed;padding-bottom:20px;margin-bottom:28px;">
        <div style="font-size:11px;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">
          SCRIPT GENERATOR Â· ${new Date().toLocaleDateString('he-IL')}</div>
        <h1 style="font-size:22px;font-weight:900;color:#111;line-height:1.2;">×¡×§×¨×™×¤×˜</h1>
        <div style="font-size:12px;color:#666;margin-top:6px;">
          ${esc(S.uName||'')} Â· ${esc(S.uNiche||'')} Â· ${new Date().toLocaleDateString('he-IL')}</div>
      </div>
      <div style="font-size:13px;line-height:1.9;white-space:pre-wrap;color:#111;">${esc(clean)}</div>`;

    const { jsPDF } = window.jspdf;
    const canvas = await html2canvas(document.getElementById('pdfArea'),
      { scale:1.5, backgroundColor:'#fff', logging:false });
    const doc = new jsPDF('p','mm','a4');
    const m=12, pw=210-m*2, pxpm=canvas.width/pw, phPx=(297-m*2)*pxpm;
    const pages = Math.ceil(canvas.height/phPx);
    for (let p=0; p<pages; p++) {
      if (p>0) doc.addPage();
      const sy=p*phPx, sh=Math.min(phPx, canvas.height-sy);
      const tmp=document.createElement('canvas');
      tmp.width=canvas.width; tmp.height=sh;
      tmp.getContext('2d').drawImage(canvas,0,sy,canvas.width,sh,0,0,canvas.width,sh);
      doc.addImage(tmp.toDataURL('image/jpeg',0.92),'JPEG',m,m,pw,sh/pxpm);
    }
    const fname = `script-${new Date().toISOString().slice(0,10)}`;
    doc.save(`${fname}.pdf`);
    showToast(`âœ“ "${fname}.pdf" ×”×•×¨×“`, 'ok');
  } catch(e) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([script],{type:'text/plain;charset=utf-8'}));
    a.download = 'script.txt'; a.click();
    showToast('×”×•×¨×“ ×›×˜×§×¡×˜', 'ok');
  }
}

// â”€â”€ Helpers â”€â”€
function g(id)    { return document.getElementById(id).value.trim(); }
function show(id) { document.getElementById(id).classList.add('show'); }
function hide(id) { document.getElementById(id).classList.remove('show'); }
function showErr(m){ const e=document.getElementById('errb'); e.textContent=m; e.classList.add('show'); }
function setBtn(d, icon='âœ¨', txt='×¦×•×¨ ×¡×§×¨×™×¤×˜') {
  document.getElementById('goBtn').disabled = d;
  document.getElementById('goBtnIcon').innerHTML = icon;
  document.getElementById('goBtnText').textContent = txt;
}
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
let toastT;
function showToast(m, c='ok') {
  const e = document.getElementById('toast');
  e.textContent = m; e.className = `toast ${c} show`;
  clearTimeout(toastT);
  toastT = setTimeout(() => e.classList.remove('show'), 3800);
}
</script>
</body>
</html>
