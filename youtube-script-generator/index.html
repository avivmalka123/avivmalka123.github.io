<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Script Generator âœ¦</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap');

:root {
  --bg: #080810;
  --surface: #10101c;
  --surface2: #16162a;
  --border: rgba(255,255,255,0.08);
  --text: #e8e8f0;
  --muted: #6b6b8a;
  --accent: #7c3aed;
  --pink: #ec4899;
  --green: #10b981;
  --red: #ef4444;
  --glow: rgba(124,58,237,0.35);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Heebo', sans-serif;
  min-height: 100vh;
  direction: rtl;
}

/* Ambient */
body::before {
  content: '';
  position: fixed; top: -30%; right: -10%;
  width: 600px; height: 600px;
  background: radial-gradient(circle, rgba(124,58,237,0.1) 0%, transparent 65%);
  pointer-events: none;
  animation: drift 20s ease-in-out infinite alternate;
  z-index: 0;
}
@keyframes drift { 0% { transform: translate(0,0) } 100% { transform: translate(40px, 60px) } }

/* â”€â”€ Nav â”€â”€ */
nav {
  position: fixed; top: 0; left: 0; right: 0; z-index: 100;
  height: 58px;
  background: rgba(8,8,16,0.9);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 32px;
}
.logo {
  display: flex; align-items: center; gap: 10px;
  font-size: 16px; font-weight: 800;
  text-decoration: none; color: var(--text);
}
.logo-dot {
  width: 32px; height: 32px;
  background: linear-gradient(135deg, var(--accent), var(--pink));
  border-radius: 9px;
  display: flex; align-items: center; justify-content: center;
  font-size: 15px;
  box-shadow: 0 0 16px var(--glow);
}
.logo span { background: linear-gradient(135deg, #a855f7, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.back-link {
  font-size: 13px; color: var(--muted); text-decoration: none;
  padding: 6px 14px; border-radius: 8px; border: 1px solid var(--border);
  transition: all 0.2s;
}
.back-link:hover { color: var(--text); background: var(--surface2); }

/* â”€â”€ Page â”€â”€ */
.page {
  position: relative; z-index: 1;
  max-width: 720px;
  margin: 0 auto;
  padding: 100px 24px 80px;
}

/* â”€â”€ Header â”€â”€ */
.page-header { text-align: center; margin-bottom: 48px; }
.page-header h1 {
  font-size: clamp(28px, 5vw, 44px);
  font-weight: 900;
  letter-spacing: -1px;
  line-height: 1.1;
  margin-bottom: 12px;
}
.page-header h1 em {
  font-style: normal;
  background: linear-gradient(135deg, #a855f7, #ec4899);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.page-header p { font-size: 15px; color: var(--muted); line-height: 1.6; }

/* â”€â”€ Settings (collapsible) â”€â”€ */
.settings-wrap {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  margin-bottom: 20px;
  overflow: hidden;
}
.settings-toggle {
  width: 100%; display: flex; align-items: center; justify-content: space-between;
  padding: 14px 20px;
  background: none; border: none; color: var(--muted);
  font-family: 'Heebo', sans-serif; font-size: 13px; font-weight: 600;
  cursor: pointer; text-align: right;
  transition: color 0.2s;
}
.settings-toggle:hover { color: var(--text); }
.settings-toggle .arrow { transition: transform 0.25s; font-size: 11px; }
.settings-toggle.open .arrow { transform: rotate(180deg); }
.settings-body { display: none; padding: 0 20px 20px; }
.settings-body.open { display: block; }
.fields { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 14px; }
.field { display: flex; flex-direction: column; gap: 5px; }
.field label { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
.field input, .field textarea {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 9px;
  padding: 9px 12px;
  color: var(--text);
  font-family: 'Heebo', sans-serif;
  font-size: 13px;
  outline: none;
  transition: border-color 0.2s;
  width: 100%;
  direction: rtl;
}
.field input[type=password] { direction: ltr; text-align: right; }
.field input:focus, .field textarea:focus { border-color: var(--accent); }
.field input::placeholder, .field textarea::placeholder { color: var(--muted); }
.field textarea { resize: vertical; min-height: 64px; }
.field.full { grid-column: 1 / -1; }
.key-ok { font-size: 11px; color: var(--green); margin-top: 2px; }

/* â”€â”€ URL Box â”€â”€ */
.url-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 12px;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.url-box:focus-within {
  border-color: rgba(168,85,247,0.4);
  box-shadow: 0 0 0 4px rgba(124,58,237,0.08);
}
.url-label {
  font-size: 12px; font-weight: 700; color: var(--muted);
  text-transform: uppercase; letter-spacing: 0.5px;
  margin-bottom: 10px;
}
.url-row { display: flex; gap: 10px; }
.url-input {
  flex: 1;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px 16px;
  color: var(--text);
  font-family: 'Heebo', sans-serif;
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s;
  direction: ltr;
  text-align: left;
}
.url-input:focus { border-color: rgba(168,85,247,0.5); }
.url-input::placeholder { color: var(--muted); }
.go-btn {
  padding: 12px 24px;
  background: linear-gradient(135deg, var(--accent), var(--pink));
  border: none; border-radius: 10px;
  color: white; font-family: 'Heebo', sans-serif;
  font-size: 14px; font-weight: 700;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(124,58,237,0.4);
  transition: all 0.2s;
  white-space: nowrap;
  display: flex; align-items: center; gap: 8px;
}
.go-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 28px rgba(124,58,237,0.5); }
.go-btn:disabled { opacity: 0.45; cursor: not-allowed; transform: none; }
@keyframes spin { to { transform: rotate(360deg); } }
.spinner { animation: spin 0.8s linear infinite; display: inline-block; }

/* â”€â”€ Progress â”€â”€ */
.progress-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 16px;
  display: none;
}
.progress-box.show { display: block; }

.step-list { display: flex; flex-direction: column; gap: 12px; }
.step {
  display: flex; align-items: center; gap: 12px;
  font-size: 14px; color: var(--muted);
  transition: color 0.3s;
}
.step.active { color: var(--text); }
.step.done { color: var(--green); }
.step.err { color: var(--red); }
.step-icon {
  width: 28px; height: 28px; border-radius: 50%;
  background: var(--surface2);
  border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 700; flex-shrink: 0;
  transition: all 0.3s;
}
.step.active .step-icon { background: var(--accent); border-color: var(--accent); color: white; animation: pulse-icon 1.2s infinite; }
.step.done  .step-icon { background: var(--green); border-color: var(--green); color: white; }
.step.err   .step-icon { background: var(--red); border-color: var(--red); color: white; }
@keyframes pulse-icon { 0%,100% { box-shadow: 0 0 0 0 rgba(124,58,237,0.4) } 50% { box-shadow: 0 0 0 8px rgba(124,58,237,0) } }

/* â”€â”€ Error box â”€â”€ */
.err-box {
  background: rgba(239,68,68,0.08);
  border: 1px solid rgba(239,68,68,0.25);
  border-radius: 12px; padding: 14px 16px;
  font-size: 13px; color: #fca5a5; line-height: 1.6;
  margin-bottom: 12px;
  display: none;
}
.err-box.show { display: block; }

/* Manual paste */
.manual-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px; padding: 20px;
  margin-bottom: 12px;
  display: none;
}
.manual-box.show { display: block; }
.manual-box label { font-size: 12px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 10px; }
.manual-box textarea {
  width: 100%; background: var(--surface2); border: 1px solid var(--border);
  border-radius: 10px; padding: 12px; color: var(--text);
  font-family: 'Heebo', sans-serif; font-size: 13px;
  outline: none; resize: vertical; min-height: 100px; direction: rtl;
  transition: border-color 0.2s;
}
.manual-box textarea:focus { border-color: var(--accent); }
.manual-btn {
  margin-top: 10px; width: 100%;
  padding: 11px; background: linear-gradient(135deg, var(--accent), var(--pink));
  border: none; border-radius: 10px; color: white;
  font-family: 'Heebo', sans-serif; font-size: 14px; font-weight: 700;
  cursor: pointer; transition: all 0.2s;
}
.manual-btn:hover { opacity: 0.9; }

/* â”€â”€ Output â”€â”€ */
.output-box {
  background: var(--surface);
  border: 1px solid rgba(16,185,129,0.25);
  border-radius: 16px;
  overflow: hidden;
  margin-bottom: 12px;
  display: none;
  box-shadow: 0 0 40px rgba(16,185,129,0.06);
}
.output-box.show { display: block; }
.output-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
}
.output-title { font-size: 14px; font-weight: 800; }
.output-meta { font-size: 11px; color: var(--muted); }
.output-actions { display: flex; gap: 8px; flex-shrink: 0; }
.action-btn {
  padding: 7px 14px; border-radius: 8px; border: none;
  font-family: 'Heebo', sans-serif; font-size: 12px; font-weight: 700;
  cursor: pointer; display: flex; align-items: center; gap: 6px;
  transition: all 0.2s;
}
.btn-copy { background: var(--surface2); border: 1px solid var(--border); color: var(--text); }
.btn-copy:hover { background: var(--surface); }
.btn-pdf { background: linear-gradient(135deg, #10b981, #059669); color: white; }
.btn-pdf:hover { transform: translateY(-1px); }
.output-script {
  padding: 24px;
  font-size: 14px; line-height: 1.85;
  white-space: pre-wrap;
  direction: rtl;
  max-height: 600px;
  overflow-y: auto;
}
.output-script::-webkit-scrollbar { width: 4px; }
.output-script::-webkit-scrollbar-track { background: transparent; }
.output-script::-webkit-scrollbar-thumb { background: var(--surface2); border-radius: 2px; }

/* Section labels inside script */
.output-script .section-label {
  display: block;
  font-size: 11px; font-weight: 800; color: var(--accent);
  text-transform: uppercase; letter-spacing: 1px;
  margin: 20px 0 6px; padding: 4px 10px;
  background: rgba(124,58,237,0.1);
  border-right: 3px solid var(--accent);
  border-radius: 0 6px 6px 0;
}

/* Toast */
.toast {
  position: fixed; bottom: 24px; left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; padding: 10px 20px;
  font-size: 13px; font-weight: 600;
  z-index: 9999; transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
  box-shadow: 0 8px 32px rgba(0,0,0,0.5); white-space: nowrap;
}
.toast.show { transform: translateX(-50%) translateY(0); }
.toast.t-ok  { border-color: rgba(16,185,129,0.4); color: #34d399; }
.toast.t-err { border-color: rgba(239,68,68,0.4); color: #f87171; }

/* Hidden PDF area */
#pdfArea {
  position: fixed; top: -9999px; right: -9999px;
  width: 820px; background: white; color: #111;
  font-family: Arial, sans-serif; direction: rtl; text-align: right;
  padding: 52px;
}
</style>
</head>
<body>

<nav>
  <a class="logo" href="/"><div class="logo-dot">âœ¦</div><span>Aviv Malka</span></a>
  <a class="back-link" href="/">â† ×›×œ ×”×›×œ×™×</a>
</nav>

<div class="page">

  <!-- Header -->
  <div class="page-header">
    <h1>ğŸ¬ <em>Script Generator</em></h1>
    <p>×”×“×‘×§ ×œ×™× ×§ ×™×•×˜×™×•×‘ â€” ×”×›×œ×™ ×©×•×œ×£ ×ª××œ×•×œ ×•×™×•×¦×¨ ×¡×§×¨×™×¤×˜ ××œ× ×‘×¢×‘×¨×™×ª ×’×‘×•×”×”</p>
  </div>

  <!-- Settings -->
  <div class="settings-wrap">
    <button class="settings-toggle" id="settingsToggle" onclick="toggleSettings()">
      <span>âš™ï¸ &nbsp;×”×’×“×¨×•×ª (Claude API Key + ×¤×¨×•×¤×™×œ)</span>
      <span class="arrow">â–¼</span>
    </button>
    <div class="settings-body" id="settingsBody">
      <div class="fields">
        <div class="field">
          <label>Claude API Key *</label>
          <input type="password" id="apiKey" placeholder="sk-ant-api03-..." oninput="saveSettings()">
          <span class="key-ok" id="keyOk" style="display:none">âœ“ ××•×’×“×¨</span>
        </div>
        <div class="field">
          <label>×”×©× / ×”××•×ª×’ ×©×œ×š</label>
          <input type="text" id="userName" placeholder="Aviv Malka" oninput="saveSettings()">
        </div>
        <div class="field">
          <label>×ª×—×•× ×”××™×§×•××¨×¡</label>
          <input type="text" id="userNiche" placeholder="×“×¨×•×¤×©×™×¤×™× ×’, ×××–×•×Ÿ FBA..." oninput="saveSettings()">
        </div>
        <div class="field">
          <label>×§×”×œ ×™×¢×“ / ×¡×’× ×•×Ÿ</label>
          <input type="text" id="userAudience" placeholder="×™×–××™× 20-35, TikTok + Shopify..." oninput="saveSettings()">
        </div>
      </div>
    </div>
  </div>

  <!-- URL Input -->
  <div class="url-box">
    <div class="url-label">×œ×™× ×§ ×œ×¡×¨×˜×•×Ÿ ×™×•×˜×™×•×‘</div>
    <div class="url-row">
      <input
        type="text"
        class="url-input"
        id="urlInput"
        placeholder="https://www.youtube.com/watch?v=..."
        onkeydown="if(event.key==='Enter') startProcess()"
      >
      <button class="go-btn" id="goBtn" onclick="startProcess()">
        <span id="goBtnIcon">âœ¨</span>
        <span id="goBtnText">×¦×•×¨ ×¡×§×¨×™×¤×˜</span>
      </button>
    </div>
  </div>

  <!-- Progress -->
  <div class="progress-box" id="progressBox">
    <div class="step-list">
      <div class="step" id="step0">
        <div class="step-icon" id="step0-icon">1</div>
        <span>×©×œ×™×¤×ª ××™×“×¢ ××™×•×˜×™×•×‘</span>
      </div>
      <div class="step" id="step1">
        <div class="step-icon" id="step1-icon">2</div>
        <span>×—×™×œ×•×¥ ×ª××œ×•×œ</span>
      </div>
      <div class="step" id="step2">
        <div class="step-icon" id="step2-icon">3</div>
        <span>×›×ª×™×‘×ª ×¡×§×¨×™×¤×˜ ×¢× Claude</span>
      </div>
    </div>
  </div>

  <!-- Error -->
  <div class="err-box" id="errBox"></div>

  <!-- Manual transcript fallback -->
  <div class="manual-box" id="manualBox">
    <label>×œ× × ××¦××• ×›×ª×•×‘×™×•×ª â€” ×”×“×‘×§ ××ª ×ª×•×›×Ÿ ×”×¡×¨×˜×•×Ÿ ×™×“× ×™×ª</label>
    <textarea id="manualText" placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×ª××œ×•×œ/×ª×•×›×Ÿ ×”×¡×¨×˜×•×Ÿ..."></textarea>
    <button class="manual-btn" onclick="runWithManual()">âœ¨ ×™×¦×•×¨ ×¡×§×¨×™×¤×˜ ××”×ª××œ×•×œ</button>
  </div>

  <!-- Output -->
  <div class="output-box" id="outputBox">
    <div class="output-header">
      <div>
        <div class="output-title" id="outputTitle">×”×¡×§×¨×™×¤×˜ ××•×›×Ÿ</div>
        <div class="output-meta" id="outputMeta"></div>
      </div>
      <div class="output-actions">
        <button class="action-btn btn-copy" onclick="copyScript()">ğŸ“‹ ×”×¢×ª×§</button>
        <button class="action-btn btn-pdf"  onclick="downloadPDF()">ğŸ“„ PDF</button>
      </div>
    </div>
    <div class="output-script" id="outputScript"></div>
  </div>

</div>

<div class="toast" id="toast"></div>
<div id="pdfArea"></div>

<script>
// â”€â”€ State â”€â”€
let videoTitle = '';
let videoTranscript = '';
let generatedScript = '';
let wordCount = 0;
let settings = { apiKey:'', userName:'', userNiche:'', userAudience:'' };

// â”€â”€ Init â”€â”€
loadSettings();

// â”€â”€ Settings â”€â”€
function saveSettings() {
  settings.apiKey       = document.getElementById('apiKey').value.trim();
  settings.userName     = document.getElementById('userName').value.trim();
  settings.userNiche    = document.getElementById('userNiche').value.trim();
  settings.userAudience = document.getElementById('userAudience').value.trim();
  localStorage.setItem('sg2_settings', JSON.stringify(settings));
  document.getElementById('keyOk').style.display = settings.apiKey ? 'block' : 'none';
}

function loadSettings() {
  try {
    const s = JSON.parse(localStorage.getItem('sg2_settings') || '{}');
    Object.assign(settings, s);
    document.getElementById('apiKey').value       = s.apiKey       || '';
    document.getElementById('userName').value     = s.userName     || '';
    document.getElementById('userNiche').value    = s.userNiche    || '';
    document.getElementById('userAudience').value = s.userAudience || '';
    document.getElementById('keyOk').style.display = s.apiKey ? 'block' : 'none';
  } catch(e) {}
}

function toggleSettings() {
  const body  = document.getElementById('settingsBody');
  const btn   = document.getElementById('settingsToggle');
  const isOpen = body.classList.toggle('open');
  btn.classList.toggle('open', isOpen);
}

// â”€â”€ Steps â”€â”€
function setStep(idx, state) {
  // state: 'active' | 'done' | 'err' | ''
  const el   = document.getElementById(`step${idx}`);
  const icon = document.getElementById(`step${idx}-icon`);
  el.className = 'step ' + state;
  if      (state === 'done') icon.innerHTML = 'âœ“';
  else if (state === 'err')  icon.innerHTML = 'âœ—';
  else                       icon.innerHTML = idx + 1;
}

function resetSteps() {
  [0,1,2].forEach(i => setStep(i, ''));
}

// â”€â”€ Extract Video ID â”€â”€
function extractId(url) {
  const m = url.match(/(?:youtube\.com\/(?:watch\?v=|shorts\/|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
  return m ? m[1] : null;
}

// â”€â”€ Fetch Transcript â”€â”€
async function fetchTranscript(videoId) {
  const PROXY = 'https://corsproxy.io/?';

  try {
    const res = await fetch(PROXY + encodeURIComponent(`https://www.youtube.com/watch?v=${videoId}`),
      { headers: { 'Accept-Language': 'en-US,en;q=0.9' } });
    const html = await res.text();

    // Extract ytInitialPlayerResponse
    const idx = html.indexOf('ytInitialPlayerResponse=');
    if (idx !== -1) {
      const slice = html.slice(idx + 'ytInitialPlayerResponse='.length);
      let depth = 0, end = 0, inStr = false, esc = false;
      for (let i = 0; i < slice.length; i++) {
        const ch = slice[i];
        if (esc) { esc = false; continue; }
        if (ch === '\\' && inStr) { esc = true; continue; }
        if (ch === '"') inStr = !inStr;
        if (!inStr) {
          if (ch === '{') depth++;
          else if (ch === '}') { depth--; if (depth === 0) { end = i + 1; break; } }
        }
      }
      if (end > 0) {
        let pr;
        try { pr = JSON.parse(slice.slice(0, end)); } catch(e) {}
        if (pr) {
          const title  = pr?.videoDetails?.title || '';
          const tracks = pr?.captions?.playerCaptionsTracklistRenderer?.captionTracks;
          if (tracks && tracks.length > 0) {
            const track = tracks.find(t => ['iw','he'].includes(t.languageCode))
                       || tracks.find(t => t.languageCode?.startsWith('en'))
                       || tracks[0];
            const capRes = await fetch(PROXY + encodeURIComponent(track.baseUrl + '&fmt=json3'));
            if (capRes.ok) {
              const cap = await capRes.json();
              const text = (cap.events || [])
                .filter(e => e.segs)
                .map(e => e.segs.map(s => s.utf8 || '').join(''))
                .join(' ').replace(/\s+/g, ' ').trim();
              if (text.length > 80) return { text, title, lang: track.languageCode };
            }
          }
        }
      }
    }
  } catch(e) { console.warn('Fetch error:', e); }

  // Fallback: direct timedtext
  const PROXY2 = 'https://corsproxy.io/?';
  for (const lang of ['iw', 'he', 'en']) {
    try {
      const res = await fetch(PROXY2 + encodeURIComponent(
        `https://www.youtube.com/api/timedtext?v=${videoId}&lang=${lang}&fmt=json3`));
      if (res.ok) {
        const d = await res.json();
        const text = (d.events || []).filter(e => e.segs)
          .map(e => e.segs.map(s => s.utf8||'').join('')).join(' ').replace(/\s+/g,' ').trim();
        if (text.length > 80) return { text, title: '', lang };
      }
    } catch(e) {}
  }
  return null;
}

// â”€â”€ Claude API â”€â”€
async function generateScript(transcript, title, wc) {
  if (!settings.apiKey) throw new Error('× ×“×¨×© Claude API Key â€” ×¤×ª×— ×”×’×“×¨×•×ª ×œ××¢×œ×”');

  const name     = settings.userName     || '×”×™×•×¦×¨';
  const niche    = settings.userNiche    || '××™×§×•××¨×¡';
  const audience = settings.userAudience || '';

  const prompt = `××ª×” ××•××—×” ×œ×›×ª×™×‘×ª ×¡×§×¨×™×¤×˜×™× ×œ×¡×¨×˜×•× ×™ ×™×•×˜×™×•×‘ â€” ×¢×‘×¨×™×ª ×’×‘×•×”×”, ×××™×ª×™×ª, ×“×™×‘×•×¨×™×ª.

**×”×¡×¨×˜×•×Ÿ ×”××§×•×¨×™:**
×›×•×ª×¨×ª: ${title || '(×œ× ×™×“×•×¢×”)'}
××•×¨×š: ~${wc} ××™×œ×™×

**×ª××œ×•×œ:**
"""
${transcript.slice(0, 7000)}${transcript.length > 7000 ? '\n[...]' : ''}
"""

**×¤×¨×˜×™ ×”×™×•×¦×¨:**
×©×: ${name}
×ª×—×•×: ${niche}
${audience ? `×§×”×œ ×™×¢×“: ${audience}` : ''}

**××” ×œ×›×ª×•×‘:**
- ×¡×§×¨×™×¤×˜ ×—×“×© ×œ×—×œ×•×˜×™×Ÿ (×œ× ×ª×¨×’×•×, ×œ× ×¤×¨×¤×¨×–×”)
- ××•×ª×• × ×•×©× ×•××‘× ×” â€” ×× ×§×•×“×ª ×”××‘×˜ ×©×œ ${name} ×‘×¢×•×œ× ×”${niche}
- ××•×¨×š ×–×”×”: ~${wc} ××™×œ×™×
- ×¢×‘×¨×™×ª ×“×™×‘×•×¨×™×ª ×’×‘×•×”×”, ×›××™×œ×• ××“×‘×¨ ××•×œ ××¦×œ××”
- ××‘× ×”: ×”×•×§ â†’ ×¤×ª×™×—×” â†’ ×’×•×£ â†’ ×¡×™×›×•× + CTA

**×¤×•×¨××˜:**

[HOOK]
(30 ×©× ×™×•×ª ×¨××©×•× ×•×ª)

[INTRO]
(×”×¦×’×” + ××” ×”×¦×•×¤×” ×™×§×‘×œ)

[BODY]
(×’×•×£ ×”×¡×¨×˜×•×Ÿ, ×¤×¡×§××•×ª ×××•×¡×¤×¨×•×ª)

[OUTRO]
(×¡×™×›×•× ×•×§×¨×™××” ×œ×¤×¢×•×œ×”)

[TITLE]
×›×•×ª×¨×ª ××•×¦×¢×ª ×œ×¡×¨×˜×•×Ÿ

×›×ª×•×‘ ×¨×§ ××ª ×”×¡×§×¨×™×¤×˜.`;

  const res = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': settings.apiKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({
      model: 'claude-opus-4-6',
      max_tokens: 8192,
      messages: [{ role: 'user', content: prompt }]
    })
  });

  if (!res.ok) {
    let msg = `×©×’×™××ª API (${res.status})`;
    try { const e = await res.json(); msg = e?.error?.message || msg; } catch(e) {}
    throw new Error(msg);
  }

  const data = await res.json();
  return data.content[0].text;
}

// â”€â”€ Main Flow â”€â”€
async function startProcess() {
  const url = document.getElementById('urlInput').value.trim();
  if (!url) { toast('×”×“×‘×§ ×œ×™× ×§ ×™×•×˜×™×•×‘', 't-err'); return; }

  const videoId = extractId(url);
  if (!videoId) { toast('×œ×™× ×§ ×œ× ×ª×§×™×Ÿ â€” ×•×“× ×©×–×” ×œ×™× ×§ ×™×•×˜×™×•×‘', 't-err'); return; }

  if (!settings.apiKey) {
    toast('×¤×ª×— ×”×’×“×¨×•×ª ×•×”×›× ×¡ Claude API Key', 't-err');
    // Auto-open settings
    const body = document.getElementById('settingsBody');
    const btn  = document.getElementById('settingsToggle');
    if (!body.classList.contains('open')) { body.classList.add('open'); btn.classList.add('open'); }
    return;
  }

  // Reset UI
  hide('errBox'); hide('manualBox'); hide('outputBox');
  show('progressBox');
  setBtn(true, '<span class="spinner">â³</span>', '×¢×•×‘×“...');
  resetSteps();

  videoTitle = ''; videoTranscript = '';

  // Step 0: Fetch
  setStep(0, 'active');
  let result;
  try {
    result = await fetchTranscript(videoId);
  } catch(e) {
    setStep(0, 'err');
    showError(`×©×’×™××” ×‘×©×œ×™×¤×”: ${e.message}`);
    showManual();
    setBtn(false, 'âœ¨', '×¦×•×¨ ×¡×§×¨×™×¤×˜');
    return;
  }

  if (!result) {
    setStep(0, 'err');
    showError('×œ× × ××¦××• ×›×ª×•×‘×™×•×ª ×œ×¡×¨×˜×•×Ÿ ×–×”. ×™×™×ª×›×Ÿ ×©×”×›×ª×•×‘×™×•×ª ××•×©×‘×ª×•×ª.');
    showManual();
    setBtn(false, 'âœ¨', '×¦×•×¨ ×¡×§×¨×™×¤×˜');
    return;
  }

  setStep(0, 'done');
  videoTranscript = result.text;
  videoTitle      = result.title || '';
  wordCount       = result.text.split(/\s+/).filter(w => w).length;

  // Step 1: Transcribed
  setStep(1, 'active');
  await sleep(300);
  setStep(1, 'done');

  // Step 2: Generate
  setStep(2, 'active');
  try {
    generatedScript = await generateScript(videoTranscript, videoTitle, wordCount);
    setStep(2, 'done');
    showOutput();
    toast('âœ“ ×”×¡×§×¨×™×¤×˜ ××•×›×Ÿ!', 't-ok');
  } catch(e) {
    setStep(2, 'err');
    showError(`×©×’×™××” ×‘×™×¦×™×¨×ª ×¡×§×¨×™×¤×˜: ${e.message}`);
  }

  setBtn(false, 'âœ¨', '×¦×•×¨ ×¡×§×¨×™×¤×˜');
}

async function runWithManual() {
  const text = document.getElementById('manualText').value.trim();
  if (!text) { toast('×”×“×‘×§ ×ª××œ×•×œ ×ª×—×™×œ×”', 't-err'); return; }
  if (!settings.apiKey) { toast('× ×“×¨×© Claude API Key', 't-err'); return; }

  videoTranscript = text;
  wordCount = text.split(/\s+/).filter(w => w).length;

  hide('errBox'); hide('manualBox');
  show('progressBox');
  resetSteps();
  setStep(0, 'done');
  setStep(1, 'done');
  setStep(2, 'active');

  try {
    generatedScript = await generateScript(text, videoTitle, wordCount);
    setStep(2, 'done');
    showOutput();
    toast('âœ“ ×”×¡×§×¨×™×¤×˜ ××•×›×Ÿ!', 't-ok');
  } catch(e) {
    setStep(2, 'err');
    showError(`×©×’×™××”: ${e.message}`);
  }
}

// â”€â”€ Show Output â”€â”€
function showOutput() {
  const formatted = formatScript(generatedScript);
  document.getElementById('outputTitle').textContent  = videoTitle || '×”×¡×§×¨×™×¤×˜ ××•×›×Ÿ âœ“';
  document.getElementById('outputMeta').textContent   = `~${wordCount.toLocaleString()} ××™×œ×™× ××§×•×¨×™×•×ª`;
  document.getElementById('outputScript').innerHTML   = formatted;
  show('outputBox');
  document.getElementById('outputBox').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function formatScript(s) {
  return s
    .replace(/\[HOOK\]/g,   '<span class="section-label">ğŸ£ ×”×•×§ â€” 30 ×©× ×™×•×ª ×¨××©×•× ×•×ª</span>')
    .replace(/\[INTRO\]/g,  '<span class="section-label">ğŸ‘‹ ×¤×ª×™×—×”</span>')
    .replace(/\[BODY\]/g,   '<span class="section-label">ğŸ“ ×’×•×£ ×”×¡×¨×˜×•×Ÿ</span>')
    .replace(/\[OUTRO\]/g,  '<span class="section-label">ğŸš€ ×¡×™×›×•× ×•×§×¨×™××” ×œ×¤×¢×•×œ×”</span>')
    .replace(/\[TITLE\]/g,  '<span class="section-label">ğŸ“Œ ×›×•×ª×¨×ª ××•×¦×¢×ª</span>')
    .replace(/\n/g, '<br>');
}

// â”€â”€ Copy â”€â”€
function copyScript() {
  if (!generatedScript) return;
  navigator.clipboard.writeText(generatedScript)
    .then(() => toast('âœ“ ×”×¡×§×¨×™×¤×˜ ×”×•×¢×ª×§', 't-ok'))
    .catch(() => toast('×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§', 't-err'));
}

// â”€â”€ PDF â”€â”€
async function downloadPDF() {
  if (!generatedScript) return;
  toast('â³ ×™×•×¦×¨ PDF...', 't-ok');

  try {
    const el = document.getElementById('pdfArea');
    const clean = generatedScript
      .replace(/\[HOOK\]/g,  '\nâ”â”â” ğŸ£ ×”×•×§ â”â”â”\n')
      .replace(/\[INTRO\]/g, '\nâ”â”â” ğŸ‘‹ ×¤×ª×™×—×” â”â”â”\n')
      .replace(/\[BODY\]/g,  '\nâ”â”â” ğŸ“ ×’×•×£ ×”×¡×¨×˜×•×Ÿ â”â”â”\n')
      .replace(/\[OUTRO\]/g, '\nâ”â”â” ğŸš€ ×¡×™×›×•× ×•CTA â”â”â”\n')
      .replace(/\[TITLE\]/g, '\nâ”â”â” ğŸ“Œ ×›×•×ª×¨×ª ××•×¦×¢×ª â”â”â”\n');

    el.innerHTML = `
      <div style="border-bottom:3px solid #7c3aed;padding-bottom:20px;margin-bottom:28px;">
        <div style="font-size:11px;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">
          SCRIPT GENERATOR Â· ${new Date().toLocaleDateString('he-IL')}
        </div>
        <h1 style="font-size:24px;font-weight:900;color:#111;line-height:1.2;">
          ${esc(videoTitle || '×”×¡×§×¨×™×¤×˜ ×©×œ×™')}
        </h1>
        <div style="font-size:12px;color:#666;margin-top:6px;">
          ${esc(settings.userName||'')} Â· ~${wordCount.toLocaleString()} ××™×œ×™×
        </div>
      </div>
      <div style="font-size:13px;line-height:1.85;white-space:pre-wrap;color:#111;">${esc(clean)}</div>`;

    const { jsPDF } = window.jspdf;
    const canvas = await html2canvas(el, { scale: 1.5, backgroundColor: '#ffffff', logging: false });
    const doc = new jsPDF('p','mm','a4');
    const m = 12, pw = 210 - m*2;
    const pxpm = canvas.width / pw;
    const phPx = (297 - m*2) * pxpm;
    const pages = Math.ceil(canvas.height / phPx);

    for (let p = 0; p < pages; p++) {
      if (p > 0) doc.addPage();
      const sy = p * phPx;
      const sh = Math.min(phPx, canvas.height - sy);
      const tmp = document.createElement('canvas');
      tmp.width = canvas.width; tmp.height = sh;
      tmp.getContext('2d').drawImage(canvas, 0, sy, canvas.width, sh, 0, 0, canvas.width, sh);
      doc.addImage(tmp.toDataURL('image/jpeg', 0.92), 'JPEG', m, m, pw, sh/pxpm);
    }

    const fname = (videoTitle || 'script').replace(/[^\w\u0590-\u05FF\s-]/g,'').trim().replace(/\s+/g,'-').slice(0,60);
    doc.save(`${fname}.pdf`);
    toast(`âœ“ "${fname}.pdf" ×”×•×¨×“`, 't-ok');
  } catch(e) {
    console.error(e);
    // Fallback: plain text
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([generatedScript], {type:'text/plain;charset=utf-8'}));
    a.download = 'script.txt'; a.click();
    toast('×”×•×¨×“ ×›×§×•×‘×¥ ×˜×§×¡×˜', 't-ok');
  }
}

// â”€â”€ Helpers â”€â”€
function show(id) { document.getElementById(id).classList.add('show'); }
function hide(id) { document.getElementById(id).classList.remove('show'); }
function showError(msg) { const el = document.getElementById('errBox'); el.textContent = msg; el.classList.add('show'); }
function showManual()   { document.getElementById('manualBox').classList.add('show'); }
function setBtn(disabled, icon, text) {
  document.getElementById('goBtn').disabled = disabled;
  document.getElementById('goBtnIcon').innerHTML = icon;
  document.getElementById('goBtnText').textContent = text;
}
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

let toastTimer;
function toast(msg, cls='t-ok') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `toast ${cls} show`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 3500);
}
</script>
</body>
</html>
