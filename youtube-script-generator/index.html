<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Script Generator âœ¦</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&display=swap');

:root {
  --bg:#080810; --surface:#10101c; --surface2:#16162a; --surface3:#1e1e38;
  --border:rgba(255,255,255,0.08); --text:#e8e8f0; --muted:#6b6b8a;
  --accent:#7c3aed; --pink:#ec4899; --green:#10b981; --red:#ef4444;
  --cyan:#06b6d4; --glow:rgba(124,58,237,0.35);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Heebo',sans-serif;min-height:100vh;direction:rtl;}
body::before{content:'';position:fixed;top:-30%;right:-10%;width:600px;height:600px;
  background:radial-gradient(circle,rgba(124,58,237,0.1) 0%,transparent 65%);
  pointer-events:none;animation:drift 20s ease-in-out infinite alternate;z-index:0;}
@keyframes drift{0%{transform:translate(0,0)}100%{transform:translate(40px,60px)}}

nav{position:fixed;top:0;left:0;right:0;z-index:100;height:58px;
  background:rgba(8,8,16,0.9);backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;padding:0 32px;}
.logo{display:flex;align-items:center;gap:10px;font-size:16px;font-weight:800;text-decoration:none;color:var(--text);}
.logo-dot{width:32px;height:32px;background:linear-gradient(135deg,var(--accent),var(--pink));
  border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:15px;box-shadow:0 0 16px var(--glow);}
.logo span{background:linear-gradient(135deg,#a855f7,#ec4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.back{font-size:13px;color:var(--muted);text-decoration:none;padding:6px 14px;
  border-radius:8px;border:1px solid var(--border);transition:all 0.2s;}
.back:hover{color:var(--text);background:var(--surface2);}

.page{position:relative;z-index:1;max-width:700px;margin:0 auto;padding:96px 24px 80px;}

.page-header{text-align:center;margin-bottom:44px;}
.page-header h1{font-size:clamp(28px,5vw,44px);font-weight:900;letter-spacing:-1px;line-height:1.1;margin-bottom:12px;}
.gr{font-style:normal;background:linear-gradient(135deg,#a855f7,#ec4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.page-header p{font-size:15px;color:var(--muted);line-height:1.6;}

/* Settings */
.settings-wrap{background:var(--surface);border:1px solid var(--border);border-radius:16px;margin-bottom:18px;overflow:hidden;}
.stoggle{width:100%;display:flex;align-items:center;justify-content:space-between;
  padding:14px 20px;background:none;border:none;color:var(--muted);
  font-family:'Heebo',sans-serif;font-size:13px;font-weight:600;cursor:pointer;text-align:right;transition:color 0.2s;}
.stoggle:hover{color:var(--text);}
.stoggle .arr{transition:transform 0.25s;font-size:11px;}
.stoggle.open .arr{transform:rotate(180deg);}
.sbody{display:none;padding:4px 20px 20px;}
.sbody.open{display:block;}
.fields{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px;}
.field{display:flex;flex-direction:column;gap:5px;}
.field.full{grid-column:1/-1;}
.field label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;}
.field input{background:var(--surface2);border:1px solid var(--border);border-radius:9px;
  padding:9px 12px;color:var(--text);font-family:'Heebo',sans-serif;font-size:13px;
  outline:none;transition:border-color 0.2s;width:100%;}
.field input[type=password]{direction:ltr;text-align:right;}
.field input:focus{border-color:var(--accent);}
.field input::placeholder{color:var(--muted);}
.field-note{font-size:11px;color:var(--muted);margin-top:3px;}
.field-note a{color:var(--cyan);text-decoration:none;}
.field-note a:hover{text-decoration:underline;}
.key-ok{font-size:11px;color:var(--green);}

/* API keys status bar */
.keys-status{display:flex;gap:10px;margin-top:12px;}
.key-chip{display:flex;align-items:center;gap:6px;padding:5px 12px;border-radius:100px;font-size:11px;font-weight:700;}
.key-chip.set{background:rgba(16,185,129,0.12);border:1px solid rgba(16,185,129,0.25);color:#34d399;}
.key-chip.missing{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);color:#f87171;}

/* URL Box */
.url-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;
  padding:20px;margin-bottom:14px;transition:border-color 0.2s,box-shadow 0.2s;}
.url-box:focus-within{border-color:rgba(168,85,247,0.4);box-shadow:0 0 0 4px rgba(124,58,237,0.08);}
.url-label{font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;}
.url-row{display:flex;gap:10px;}
.url-input{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:10px;
  padding:12px 16px;color:var(--text);font-family:'Heebo',sans-serif;font-size:14px;
  outline:none;transition:border-color 0.2s;direction:ltr;text-align:left;}
.url-input:focus{border-color:rgba(168,85,247,0.5);}
.url-input::placeholder{color:var(--muted);}
.go-btn{padding:12px 22px;background:linear-gradient(135deg,var(--accent),var(--pink));
  border:none;border-radius:10px;color:white;font-family:'Heebo',sans-serif;
  font-size:14px;font-weight:700;cursor:pointer;
  box-shadow:0 4px 20px rgba(124,58,237,0.4);transition:all 0.2s;
  white-space:nowrap;display:flex;align-items:center;gap:8px;}
.go-btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 28px rgba(124,58,237,0.5);}
.go-btn:disabled{opacity:0.4;cursor:not-allowed;transform:none;}
@keyframes spin{to{transform:rotate(360deg)}}
.spin{animation:spin 0.8s linear infinite;display:inline-block;}

/* Progress */
.progress-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;
  padding:24px;margin-bottom:14px;display:none;}
.progress-box.show{display:block;}
.step-list{display:flex;flex-direction:column;gap:14px;}
.step{display:flex;align-items:center;gap:12px;font-size:14px;color:var(--muted);transition:color 0.3s;}
.step.active{color:var(--text);}
.step.done{color:var(--green);}
.step.err{color:var(--red);}
.step-ico{width:28px;height:28px;border-radius:50%;background:var(--surface2);
  border:1px solid var(--border);display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:700;flex-shrink:0;transition:all 0.3s;}
.step.active .step-ico{background:var(--accent);border-color:var(--accent);color:white;animation:pulse-ico 1.2s infinite;}
.step.done  .step-ico{background:var(--green);border-color:var(--green);color:white;}
.step.err   .step-ico{background:var(--red);border-color:var(--red);color:white;}
@keyframes pulse-ico{0%,100%{box-shadow:0 0 0 0 rgba(124,58,237,0.4)}50%{box-shadow:0 0 0 8px rgba(124,58,237,0)}}
.step-detail{font-size:12px;color:var(--muted);margin-top:2px;}

/* Timer */
.timer-row{display:flex;align-items:center;gap:8px;margin-top:14px;
  padding:10px 14px;background:rgba(6,182,212,0.06);border:1px solid rgba(6,182,212,0.15);
  border-radius:10px;font-size:12px;color:var(--cyan);display:none;}
.timer-row.show{display:flex;}
.timer-dot{width:6px;height:6px;border-radius:50%;background:var(--cyan);animation:pulse-ico 1.2s infinite;}

/* Error */
.err-box{background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.25);
  border-radius:12px;padding:14px 16px;font-size:13px;color:#fca5a5;line-height:1.6;
  margin-bottom:12px;display:none;}
.err-box.show{display:block;}

/* Manual */
.manual-box{background:var(--surface);border:1px solid rgba(245,158,11,0.25);
  border-radius:16px;padding:20px;margin-bottom:12px;display:none;}
.manual-box.show{display:block;}
.manual-box label{font-size:12px;font-weight:700;color:#f59e0b;text-transform:uppercase;
  letter-spacing:0.5px;display:flex;align-items:center;gap:6px;margin-bottom:12px;}
.manual-box textarea{width:100%;background:var(--surface2);border:1px solid var(--border);
  border-radius:10px;padding:12px;color:var(--text);font-family:'Heebo',sans-serif;
  font-size:13px;outline:none;resize:vertical;min-height:100px;direction:rtl;
  transition:border-color 0.2s;}
.manual-box textarea:focus{border-color:var(--accent);}
.manual-btn{margin-top:10px;width:100%;padding:11px;
  background:linear-gradient(135deg,var(--accent),var(--pink));
  border:none;border-radius:10px;color:white;font-family:'Heebo',sans-serif;
  font-size:14px;font-weight:700;cursor:pointer;transition:opacity 0.2s;}
.manual-btn:hover{opacity:0.9;}

/* Output */
.output-box{background:var(--surface);border:1px solid rgba(16,185,129,0.25);
  border-radius:16px;overflow:hidden;margin-bottom:12px;display:none;
  box-shadow:0 0 40px rgba(16,185,129,0.06);}
.output-box.show{display:block;}
.output-header{padding:16px 20px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;gap:12px;}
.output-title{font-size:14px;font-weight:800;}
.output-meta{font-size:11px;color:var(--muted);}
.output-actions{display:flex;gap:8px;flex-shrink:0;}
.abtn{padding:7px 14px;border-radius:8px;border:none;font-family:'Heebo',sans-serif;
  font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all 0.2s;}
.abtn-copy{background:var(--surface2);border:1px solid var(--border);color:var(--text);}
.abtn-copy:hover{background:var(--surface3);}
.abtn-pdf{background:linear-gradient(135deg,#10b981,#059669);color:white;}
.abtn-pdf:hover{transform:translateY(-1px);}
.output-script{padding:24px;font-size:14px;line-height:1.85;white-space:pre-wrap;
  direction:rtl;max-height:620px;overflow-y:auto;}
.output-script::-webkit-scrollbar{width:4px;}
.output-script::-webkit-scrollbar-track{background:transparent;}
.output-script::-webkit-scrollbar-thumb{background:var(--surface2);border-radius:2px;}
.slabel{display:block;font-size:11px;font-weight:800;color:var(--accent);
  text-transform:uppercase;letter-spacing:1px;margin:20px 0 6px;padding:4px 10px;
  background:rgba(124,58,237,0.1);border-right:3px solid var(--accent);border-radius:0 6px 6px 0;}

/* Toast */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:10px 20px;font-size:13px;font-weight:600;z-index:9999;
  transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
  box-shadow:0 8px 32px rgba(0,0,0,0.5);white-space:nowrap;}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast.t-ok{border-color:rgba(16,185,129,0.4);color:#34d399;}
.toast.t-err{border-color:rgba(239,68,68,0.4);color:#f87171;}

#pdfArea{position:fixed;top:-9999px;right:-9999px;width:820px;background:white;
  color:#111;font-family:Arial,sans-serif;direction:rtl;text-align:right;padding:52px;}
</style>
</head>
<body>

<nav>
  <a class="logo" href="/"><div class="logo-dot">âœ¦</div><span>Aviv Malka</span></a>
  <a class="back" href="/">â† ×›×œ ×”×›×œ×™×</a>
</nav>

<div class="page">

  <div class="page-header">
    <h1>ğŸ¬ <em class="gr">Script Generator</em></h1>
    <p>××“×‘×™×§ ×œ×™× ×§ ×™×•×˜×™×•×‘ â†’ ×××–×™×Ÿ ×œ××•×“×™×• â†’ ××ª××œ×œ â†’ ×›×•×ª×‘ ×¡×§×¨×™×¤×˜ ×‘×¢×‘×¨×™×ª ×’×‘×•×”×”</p>
  </div>

  <!-- Settings -->
  <div class="settings-wrap">
    <button class="stoggle" id="stoggle" onclick="toggleSettings()">
      <span>âš™ï¸ &nbsp;×”×’×“×¨×•×ª â€” API Keys + ×¤×¨×•×¤×™×œ</span>
      <span class="arr">â–¼</span>
    </button>
    <div class="sbody" id="sbody">
      <div class="fields">

        <div class="field">
          <label>AssemblyAI Key <span style="color:var(--red)">*</span> â€” ×œ×ª××œ×•×œ ××•×“×™×•</label>
          <input type="password" id="aaiKey" placeholder="××¤×ª×— AssemblyAI..." oninput="saveSettings()">
          <span class="field-note">
            ×§×‘×œ ××¤×ª×— ×—×™× ××™ (×›×•×œ×œ $50 ×§×¨×“×™×˜) â†
            <a href="https://www.assemblyai.com/" target="_blank">assemblyai.com</a>
          </span>
        </div>

        <div class="field">
          <label>Claude Key <span style="color:var(--red)">*</span> â€” ×œ×›×ª×™×‘×ª ×¡×§×¨×™×¤×˜</label>
          <input type="password" id="claudeKey" placeholder="sk-ant-api03-..." oninput="saveSettings()">
          <span class="field-note">
            ×§×‘×œ ××¤×ª×— â†
            <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a>
          </span>
        </div>

        <div class="field">
          <label>×”×©× / ×”××•×ª×’ ×©×œ×š</label>
          <input type="text" id="userName" placeholder="Aviv Malka" oninput="saveSettings()">
        </div>

        <div class="field">
          <label>×ª×—×•× ×”××™×§×•××¨×¡</label>
          <input type="text" id="userNiche" placeholder="×“×¨×•×¤×©×™×¤×™× ×’, ×××–×•×Ÿ FBA..." oninput="saveSettings()">
        </div>

        <div class="field full">
          <label>×§×”×œ ×™×¢×“ / ×¡×’× ×•×Ÿ</label>
          <input type="text" id="userAudience" placeholder="×™×–××™× 20-35, TikTok + Shopify, ×¡×’× ×•×Ÿ ×™×©×™×¨ ×•×××™×ª×™..." oninput="saveSettings()">
        </div>

      </div>
      <div class="keys-status">
        <div class="key-chip" id="chipAAI"><span>â—</span> AssemblyAI</div>
        <div class="key-chip" id="chipClaude"><span>â—</span> Claude</div>
      </div>
    </div>
  </div>

  <!-- URL Input -->
  <div class="url-box">
    <div class="url-label">×œ×™× ×§ ×œ×¡×¨×˜×•×Ÿ ×™×•×˜×™×•×‘</div>
    <div class="url-row">
      <input type="text" class="url-input" id="urlInput"
        placeholder="https://www.youtube.com/watch?v=..."
        onkeydown="if(event.key==='Enter') startProcess()">
      <button class="go-btn" id="goBtn" onclick="startProcess()">
        <span id="goBtnIcon">âœ¨</span>
        <span id="goBtnText">×¦×•×¨ ×¡×§×¨×™×¤×˜</span>
      </button>
    </div>
  </div>

  <!-- Progress -->
  <div class="progress-box" id="progressBox">
    <div class="step-list">
      <div class="step" id="s0">
        <div class="step-ico" id="s0i">1</div>
        <div>
          <div>×©×œ×™×¤×ª ×§×•×‘×¥ ×”××•×“×™×• ××™×•×˜×™×•×‘</div>
          <div class="step-detail" id="s0d"></div>
        </div>
      </div>
      <div class="step" id="s1">
        <div class="step-ico" id="s1i">2</div>
        <div>
          <div>×ª××œ×•×œ ××•×“×™×• ×¢× AssemblyAI</div>
          <div class="step-detail" id="s1d">×××–×™×Ÿ ×œ×¡×¨×˜×•×Ÿ ×•××ª××œ×œ...</div>
        </div>
      </div>
      <div class="step" id="s2">
        <div class="step-ico" id="s2i">3</div>
        <div>
          <div>×›×ª×™×‘×ª ×¡×§×¨×™×¤×˜ ×¢× Claude</div>
          <div class="step-detail" id="s2d"></div>
        </div>
      </div>
    </div>
    <div class="timer-row" id="timerRow">
      <div class="timer-dot"></div>
      <span id="timerText">×××ª×™×Ÿ ×œ×ª××œ×•×œ... <span id="timerCount">0</span> ×©× ×™×•×ª</span>
    </div>
  </div>

  <!-- Error -->
  <div class="err-box" id="errBox"></div>

  <!-- Manual Fallback -->
  <div class="manual-box" id="manualBox">
    <label>âš ï¸ ×œ× ×”×¦×œ×—× ×• ×œ×©×œ×•×£ â€” ×”×“×‘×§ ×ª××œ×•×œ ×™×“× ×™×ª</label>
    <textarea id="manualText" placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×ª×•×›×Ÿ / ×ª××œ×•×œ ×”×¡×¨×˜×•×Ÿ..."></textarea>
    <button class="manual-btn" onclick="runManual()">âœ¨ ×™×¦×•×¨ ×¡×§×¨×™×¤×˜ ××”×˜×§×¡×˜</button>
  </div>

  <!-- Output -->
  <div class="output-box" id="outputBox">
    <div class="output-header">
      <div>
        <div class="output-title" id="outTitle">×”×¡×§×¨×™×¤×˜ ××•×›×Ÿ âœ“</div>
        <div class="output-meta" id="outMeta"></div>
      </div>
      <div class="output-actions">
        <button class="abtn abtn-copy" onclick="copyScript()">ğŸ“‹ ×”×¢×ª×§</button>
        <button class="abtn abtn-pdf"  onclick="dlPDF()">ğŸ“„ PDF</button>
      </div>
    </div>
    <div class="output-script" id="outScript"></div>
  </div>

</div>

<div class="toast" id="toast"></div>
<div id="pdfArea"></div>

<script>
// â”€â”€ State â”€â”€
let S = { aaiKey:'', claudeKey:'', userName:'', userNiche:'', userAudience:'' };
let vidTitle = '', transcript = '', script = '', wc = 0;
let timerInterval = null, timerSec = 0;

// â”€â”€ Init â”€â”€
loadSettings();

// â”€â”€ Settings â”€â”€
function saveSettings() {
  S.aaiKey      = v('aaiKey');
  S.claudeKey   = v('claudeKey');
  S.userName    = v('userName');
  S.userNiche   = v('userNiche');
  S.userAudience= v('userAudience');
  localStorage.setItem('sg3', JSON.stringify(S));
  updateChips();
}
function loadSettings() {
  try {
    const s = JSON.parse(localStorage.getItem('sg3')||'{}');
    Object.assign(S, s);
    if(s.aaiKey)       document.getElementById('aaiKey').value       = s.aaiKey;
    if(s.claudeKey)    document.getElementById('claudeKey').value    = s.claudeKey;
    if(s.userName)     document.getElementById('userName').value     = s.userName;
    if(s.userNiche)    document.getElementById('userNiche').value    = s.userNiche;
    if(s.userAudience) document.getElementById('userAudience').value = s.userAudience;
  } catch(e) {}
  updateChips();
}
function updateChips() {
  chip('chipAAI',    !!S.aaiKey);
  chip('chipClaude', !!S.claudeKey);
}
function chip(id, ok) {
  const el = document.getElementById(id);
  el.className = 'key-chip ' + (ok ? 'set' : 'missing');
  el.querySelector('span').textContent = ok ? 'âœ“' : 'âœ—';
}
function toggleSettings() {
  const b = document.getElementById('sbody'), btn = document.getElementById('stoggle');
  const o = b.classList.toggle('open');
  btn.classList.toggle('open', o);
}
function openSettings() {
  document.getElementById('sbody').classList.add('open');
  document.getElementById('stoggle').classList.add('open');
}

// â”€â”€ Steps â”€â”€
function setStep(i, state, detail) {
  const el = document.getElementById('s'+i), ico = document.getElementById('s'+i+'i'), det = document.getElementById('s'+i+'d');
  el.className = 'step ' + state;
  ico.innerHTML = state==='done' ? 'âœ“' : state==='err' ? 'âœ—' : i+1;
  if(det && detail !== undefined) det.textContent = detail;
}
function resetAll() {
  [0,1,2].forEach(i => setStep(i,'',''));
  document.getElementById('timerRow').classList.remove('show');
  clearInterval(timerInterval);
}

// â”€â”€ Video ID â”€â”€
function extractId(url) {
  const m = url.match(/(?:youtube\.com\/(?:watch\?v=|shorts\/|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
  return m ? m[1] : null;
}

// â”€â”€ STEP 1: Get Audio URL â”€â”€
// Strategy: try Invidious (public YT proxy, no key needed) â†’ then Piped â†’ fail
async function getAudioUrl(videoId) {

  // â”€â”€ Method A: Invidious instances â”€â”€
  // Invidious is an open-source YT frontend with CORS-friendly API.
  // ?local=true returns proxy URLs served through Invidious itself â€”
  // accessible from any IP including AssemblyAI's servers.
  const INVIDIOUS = [
    'https://invidious.io.lol',
    'https://inv.tux.pizza',
    'https://invidious.nerdvpn.de',
    'https://invidious.privacydev.net',
    'https://yt.cdaut.de',
    'https://invidious.drgns.space',
  ];
  for (const base of INVIDIOUS) {
    try {
      const res = await fetch(
        `${base}/api/v1/videos/${videoId}?local=true&fields=title,adaptiveFormats`,
        { headers:{'Accept':'application/json'}, signal: AbortSignal.timeout(9000) }
      );
      if (!res.ok) continue;
      const data = await res.json();
      if (data.error) continue;
      const title = data.title || '';
      const fmts  = (data.adaptiveFormats || [])
        .filter(f => f.type?.includes('audio/') && f.url)
        .sort((a,b) => (b.bitrate||0)-(a.bitrate||0));
      if (fmts.length > 0) {
        console.log('Got audio via Invidious:', base);
        return { audioUrl: fmts[0].url, title };
      }
    } catch(e) { continue; }
  }

  // â”€â”€ Method B: Piped instances â”€â”€
  const PIPED = [
    'https://pipedapi.kavin.rocks',
    'https://piped-api.garudalinux.org',
    'https://api.piped.projectsegfau.lt',
  ];
  for (const base of PIPED) {
    try {
      const res = await fetch(`${base}/streams/${videoId}`, {
        headers:{'Accept':'application/json'}, signal: AbortSignal.timeout(9000)
      });
      if (!res.ok) continue;
      const data = await res.json();
      const streams = (data.audioStreams||[]).sort((a,b)=>(b.bitrate||0)-(a.bitrate||0));
      if (streams.length > 0) {
        console.log('Got audio via Piped:', base);
        return { audioUrl: streams[0].url, title: data.title||'' };
      }
    } catch(e) { continue; }
  }

  return null;
}

// â”€â”€ STEP 2: Transcribe with AssemblyAI â”€â”€
async function transcribeAudio(audioUrl, apiKey) {
  // Submit job
  const submitRes = await fetch('https://api.assemblyai.com/v2/transcript', {
    method: 'POST',
    headers: { 'Authorization': apiKey, 'Content-Type': 'application/json' },
    body: JSON.stringify({
      audio_url: audioUrl,
      language_detection: true,
      punctuate: true,
      format_text: true
    })
  });
  if (!submitRes.ok) {
    const e = await submitRes.json().catch(()=>({}));
    throw new Error(e?.error || `AssemblyAI Error ${submitRes.status}`);
  }
  const { id } = await submitRes.json();

  // Poll with timer
  startTimer();
  let attempts = 0;
  while (true) {
    await sleep(4000);
    attempts++;
    const pollRes = await fetch(`https://api.assemblyai.com/v2/transcript/${id}`, {
      headers: { 'Authorization': apiKey }
    });
    const data = await pollRes.json();
    setStep(1, 'active', `××ª××œ×œ... (${Math.round(timerSec)} ×©× ×™×•×ª)`);
    if (data.status === 'completed') {
      stopTimer();
      return data.text || '';
    }
    if (data.status === 'error') {
      stopTimer();
      throw new Error(data.error || '×©×’×™××ª ×ª××œ×•×œ');
    }
    if (attempts > 120) { stopTimer(); throw new Error('×ª××œ×•×œ ×œ×•×§×— ×™×•×ª×¨ ××“×™ ×–××Ÿ'); }
  }
}

function startTimer() {
  timerSec = 0;
  document.getElementById('timerRow').classList.add('show');
  timerInterval = setInterval(() => {
    timerSec++;
    document.getElementById('timerCount').textContent = timerSec;
  }, 1000);
}
function stopTimer() {
  clearInterval(timerInterval);
  document.getElementById('timerRow').classList.remove('show');
}

// â”€â”€ STEP 3: Generate Script with Claude â”€â”€
async function generateScript(text, title, wc) {
  if (!S.claudeKey) throw new Error('× ×“×¨×© Claude API Key');
  const name     = S.userName     || '×”×™×•×¦×¨';
  const niche    = S.userNiche    || '××™×§×•××¨×¡';
  const audience = S.userAudience || '';

  const prompt = `××ª×” ××•××—×” ×œ×›×ª×™×‘×ª ×¡×§×¨×™×¤×˜×™× ×œ×¡×¨×˜×•× ×™ ×™×•×˜×™×•×‘ â€” ×¢×‘×¨×™×ª ×’×‘×•×”×”, ×××™×ª×™×ª, ×“×™×‘×•×¨×™×ª.

**×”×¡×¨×˜×•×Ÿ ×”××§×•×¨×™:**
×›×•×ª×¨×ª: ${title || '×œ× ×™×“×•×¢×”'}
××•×¨×š: ~${wc} ××™×œ×™×

**×ª××œ×•×œ ××•×“×™×•:**
"""
${text.slice(0, 7500)}${text.length > 7500 ? '\n[...]' : ''}
"""

**×¤×¨×˜×™ ×”×™×•×¦×¨:**
×©×: ${name} | ×ª×—×•×: ${niche}${audience ? ` | ×§×”×œ: ${audience}` : ''}

**×”× ×—×™×•×ª:**
- ×›×ª×•×‘ ×¡×§×¨×™×¤×˜ ×—×“×© ×œ×—×œ×•×˜×™×Ÿ â€” ×œ× ×ª×¨×’×•×, ×œ× ×¤×¨×¤×¨×–×”
- ××•×ª×• × ×•×©× ×•××‘× ×”, ×× ×§×•×“×ª ×”××‘×˜ ×©×œ ${name} ×‘×¢×•×œ× ×”${niche}
- ××•×¨×š ×–×”×” ×œ×¡×¨×˜×•×Ÿ ×”××§×•×¨×™: ~${wc} ××™×œ×™×
- ×¢×‘×¨×™×ª ×“×™×‘×•×¨×™×ª ×’×‘×•×”×”, ×›××™×œ×• ××“×‘×¨ ××•×œ ××¦×œ××”
- ××‘× ×”: ×”×•×§ â†’ ×¤×ª×™×—×” â†’ ×’×•×£ â†’ ×¡×™×›×•× + CTA

**×¤×•×¨××˜ (×”×©×ª××© ×‘×“×™×•×§ ×‘×ª×’×™×):**

[HOOK]
(30 ×©× ×™×•×ª ×¨××©×•× ×•×ª)

[INTRO]
(×”×¦×’×” + ×”×‘×˜×—×” ×œ×¦×•×¤×”)

[BODY]
(×’×•×£ ×”×¡×¨×˜×•×Ÿ, ×¤×¡×§××•×ª ×××•×¡×¤×¨×•×ª)

[OUTRO]
(×¡×™×›×•× + ×§×¨×™××” ×œ×¤×¢×•×œ×”)

[TITLE]
×›×•×ª×¨×ª ××•×¦×¢×ª ×œ×¡×¨×˜×•×Ÿ

×›×ª×•×‘ ××ª ×”×¡×§×¨×™×¤×˜ ×‘×œ×‘×“.`;

  const res = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': S.claudeKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({ model: 'claude-opus-4-6', max_tokens: 8192, messages: [{ role:'user', content:prompt }] })
  });
  if (!res.ok) {
    let msg = `Claude Error ${res.status}`;
    try { const e = await res.json(); msg = e?.error?.message || msg; } catch(e) {}
    throw new Error(msg);
  }
  return (await res.json()).content[0].text;
}

// â”€â”€ Main Flow â”€â”€
async function startProcess() {
  const url = v('urlInput').trim();
  if (!url) { showToast('×”×“×‘×§ ×œ×™× ×§ ×™×•×˜×™×•×‘', 't-err'); return; }
  const videoId = extractId(url);
  if (!videoId) { showToast('×œ×™× ×§ ×œ× ×ª×§×™×Ÿ', 't-err'); return; }

  if (!S.aaiKey || !S.claudeKey) {
    showToast('× ×“×¨×©×™× ×©× ×™ ×”××¤×ª×—×•×ª â€” ×¤×ª×— ×”×’×“×¨×•×ª', 't-err');
    openSettings(); return;
  }

  // Reset
  hide('errBox'); hide('manualBox'); hide('outputBox');
  show('progressBox');
  setBtn(true, '<span class="spin">â³</span>', '×¢×•×‘×“...');
  resetAll();
  vidTitle = ''; transcript = ''; script = ''; wc = 0;

  // â”€â”€ Step 1: Get audio â”€â”€
  setStep(0, 'active', '');
  let audioData;
  try {
    audioData = await getAudioUrl(videoId);
  } catch(e) {
    setStep(0, 'err');
    showError(`×©×’×™××” ×‘×©×œ×™×¤×ª ××•×“×™×•: ${e.message}`);
    showManual();
    setBtn(false); return;
  }

  if (!audioData) {
    setStep(0, 'err');
    showError('×œ× ×”×¦×œ×—× ×• ×œ×©×œ×•×£ ××ª ×”××•×“×™×• ××™×•×˜×™×•×‘ (× ×™×¡×™× ×• 9 ×©×¨×ª×™×). ×™×™×ª×›×Ÿ ×©×”×¡×¨×˜×•×Ÿ ××•×’×‘×œ ×œ×’×™×œ / ×¤×¨×˜×™ / ××–×•×¨×™. × ×™×ª×Ÿ ×œ×”×“×‘×™×§ ××ª ×ª××œ×•×œ ×”×¡×¨×˜×•×Ÿ ×™×“× ×™×ª ×œ××˜×”.');
    showManual();
    setBtn(false); return;
  }

  vidTitle = audioData.title;
  setStep(0, 'done', audioData.title ? `"${audioData.title.slice(0,50)}"` : '');

  // â”€â”€ Step 2: Transcribe â”€â”€
  setStep(1, 'active', '×©×•×œ×— ×œ-AssemblyAI...');
  try {
    transcript = await transcribeAudio(audioData.audioUrl, S.aaiKey);
    wc = transcript.split(/\s+/).filter(w=>w).length;
    setStep(1, 'done', `${wc.toLocaleString()} ××™×œ×™× ×‘×ª××œ×•×œ`);
  } catch(e) {
    setStep(1, 'err');
    showError(`×©×’×™××ª ×ª××œ×•×œ: ${e.message}`);
    showManual();
    setBtn(false); return;
  }

  // â”€â”€ Step 3: Generate â”€â”€
  setStep(2, 'active', '');
  try {
    script = await generateScript(transcript, vidTitle, wc);
    setStep(2, 'done', '');
    showOutput();
    showToast('âœ“ ×”×¡×§×¨×™×¤×˜ ××•×›×Ÿ!', 't-ok');
  } catch(e) {
    setStep(2, 'err');
    showError(`×©×’×™××ª Claude: ${e.message}`);
  }

  setBtn(false);
}

// â”€â”€ Manual â”€â”€
async function runManual() {
  const text = document.getElementById('manualText').value.trim();
  if (!text) { showToast('×”×“×‘×§ ×ª××œ×•×œ ×ª×—×™×œ×”', 't-err'); return; }
  if (!S.claudeKey) { showToast('× ×“×¨×© Claude API Key', 't-err'); openSettings(); return; }

  transcript = text;
  wc = text.split(/\s+/).filter(w=>w).length;

  hide('errBox'); hide('manualBox');
  show('progressBox');
  resetAll();
  setStep(0,'done',''); setStep(1,'done',`${wc.toLocaleString()} ××™×œ×™×`);
  setStep(2,'active','');
  setBtn(true,'<span class="spin">â³</span>','×¢×•×‘×“...');

  try {
    script = await generateScript(text, vidTitle||'×¡×¨×˜×•×Ÿ', wc);
    setStep(2,'done','');
    showOutput();
    showToast('âœ“ ×”×¡×§×¨×™×¤×˜ ××•×›×Ÿ!', 't-ok');
  } catch(e) {
    setStep(2,'err');
    showError(`×©×’×™××”: ${e.message}`);
  }
  setBtn(false);
}

// â”€â”€ Output â”€â”€
function showOutput() {
  document.getElementById('outTitle').textContent = vidTitle || '×”×¡×§×¨×™×¤×˜ ××•×›×Ÿ âœ“';
  document.getElementById('outMeta').textContent  = `~${wc.toLocaleString()} ××™×œ×™× ×‘×ª××œ×•×œ ×”××§×•×¨×™`;
  document.getElementById('outScript').innerHTML  = formatScript(script);
  show('outputBox');
  document.getElementById('outputBox').scrollIntoView({ behavior:'smooth', block:'start' });
}

function formatScript(s) {
  return s
    .replace(/\[HOOK\]/g,  '<span class="slabel">ğŸ£ ×”×•×§ â€” 30 ×©× ×™×•×ª ×¨××©×•× ×•×ª</span>')
    .replace(/\[INTRO\]/g, '<span class="slabel">ğŸ‘‹ ×¤×ª×™×—×”</span>')
    .replace(/\[BODY\]/g,  '<span class="slabel">ğŸ“ ×’×•×£ ×”×¡×¨×˜×•×Ÿ</span>')
    .replace(/\[OUTRO\]/g, '<span class="slabel">ğŸš€ ×¡×™×›×•× ×•×§×¨×™××” ×œ×¤×¢×•×œ×”</span>')
    .replace(/\[TITLE\]/g, '<span class="slabel">ğŸ“Œ ×›×•×ª×¨×ª ××•×¦×¢×ª</span>')
    .replace(/\n/g, '<br>');
}

function copyScript() {
  if (!script) return;
  navigator.clipboard.writeText(script)
    .then(()=>showToast('âœ“ ×”×•×¢×ª×§','t-ok'))
    .catch(()=>showToast('×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§','t-err'));
}

async function dlPDF() {
  if (!script) return;
  showToast('â³ ×™×•×¦×¨ PDF...','t-ok');
  try {
    const clean = script
      .replace(/\[HOOK\]/g, '\nâ”â”â” ğŸ£ ×”×•×§ â”â”â”\n')
      .replace(/\[INTRO\]/g,'\nâ”â”â” ğŸ‘‹ ×¤×ª×™×—×” â”â”â”\n')
      .replace(/\[BODY\]/g, '\nâ”â”â” ğŸ“ ×’×•×£ ×”×¡×¨×˜×•×Ÿ â”â”â”\n')
      .replace(/\[OUTRO\]/g,'\nâ”â”â” ğŸš€ ×¡×™×›×•× ×•CTA â”â”â”\n')
      .replace(/\[TITLE\]/g,'\nâ”â”â” ğŸ“Œ ×›×•×ª×¨×ª ××•×¦×¢×ª â”â”â”\n');
    const el = document.getElementById('pdfArea');
    el.innerHTML = `
      <div style="border-bottom:3px solid #7c3aed;padding-bottom:20px;margin-bottom:28px;">
        <div style="font-size:11px;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">
          SCRIPT GENERATOR Â· ${new Date().toLocaleDateString('he-IL')}</div>
        <h1 style="font-size:24px;font-weight:900;color:#111;line-height:1.2;">${esc(vidTitle||'×”×¡×§×¨×™×¤×˜ ×©×œ×™')}</h1>
        <div style="font-size:12px;color:#666;margin-top:6px;">${esc(S.userName||'')} Â· ~${wc.toLocaleString()} ××™×œ×™×</div>
      </div>
      <div style="font-size:13px;line-height:1.85;white-space:pre-wrap;color:#111;">${esc(clean)}</div>`;
    const {jsPDF} = window.jspdf;
    const canvas = await html2canvas(el,{scale:1.5,backgroundColor:'#fff',logging:false});
    const doc = new jsPDF('p','mm','a4');
    const m=12, pw=210-m*2, pxpm=canvas.width/pw, phPx=(297-m*2)*pxpm;
    const pages=Math.ceil(canvas.height/phPx);
    for(let p=0;p<pages;p++){
      if(p>0) doc.addPage();
      const sy=p*phPx, sh=Math.min(phPx,canvas.height-sy);
      const tmp=document.createElement('canvas');
      tmp.width=canvas.width; tmp.height=sh;
      tmp.getContext('2d').drawImage(canvas,0,sy,canvas.width,sh,0,0,canvas.width,sh);
      doc.addImage(tmp.toDataURL('image/jpeg',0.92),'JPEG',m,m,pw,sh/pxpm);
    }
    const fname=(vidTitle||'script').replace(/[^\w\u0590-\u05FF\s-]/g,'').trim().replace(/\s+/g,'-').slice(0,60);
    doc.save(`${fname}.pdf`);
    showToast(`âœ“ "${fname}.pdf" ×”×•×¨×“`,'t-ok');
  } catch(e) {
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([script],{type:'text/plain;charset=utf-8'}));
    a.download='script.txt'; a.click();
    showToast('×”×•×¨×“ ×›×˜×§×¡×˜','t-ok');
  }
}

// â”€â”€ Helpers â”€â”€
function v(id) { return document.getElementById(id).value.trim(); }
function show(id) { document.getElementById(id).classList.add('show'); }
function hide(id) { document.getElementById(id).classList.remove('show'); }
function showError(msg) { const el=document.getElementById('errBox'); el.textContent=msg; el.classList.add('show'); }
function showManual()   { document.getElementById('manualBox').classList.add('show'); }
function setBtn(dis, icon='âœ¨', text='×¦×•×¨ ×¡×§×¨×™×¤×˜') {
  document.getElementById('goBtn').disabled=dis;
  document.getElementById('goBtnIcon').innerHTML=icon;
  document.getElementById('goBtnText').textContent=text;
}
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function sleep(ms) { return new Promise(r=>setTimeout(r,ms)); }
let toastT;
function showToast(msg,cls='t-ok'){
  const el=document.getElementById('toast');
  el.textContent=msg; el.className=`toast ${cls} show`;
  clearTimeout(toastT);
  toastT=setTimeout(()=>el.classList.remove('show'),3800);
}
</script>
</body>
</html>
